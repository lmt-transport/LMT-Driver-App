<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Report PDF</title>
    <style>
        /* ประกาศ Font ภาษาไทย */
        @font-face {
            font-family: 'Sarabun';
            /* ต้องระบุ path ให้ชัดเจน สำหรับ xhtml2pdf */
            src: url('{{ static_folder }}/fonts/Sarabun-Regular.ttf');
        }

        @page {
            size: a4 landscape;
            margin: 1cm;
            @frame header_frame {           /* Static Frame */
                -pdf-frame-content: header_content;
                left: 1cm; width: 27.7cm; top: 1cm; height: 2cm;
            }
            @frame content_frame {          /* Content Frame */
                left: 1cm; width: 27.7cm; top: 3.5cm; height: 16cm;
            }
        }
        
        body {
            font-family: 'Sarabun'; /* เรียกใช้ font ที่ประกาศไว้ */
            font-size: 10px;
        }

        /* ส่วนหัวกระดาษ */
        #header_content {
            text-align: center;
        }

        table {
            width: 100%;
            border: 0.5px solid #000;
            border-collapse: collapse;
            repeat-header: yes; /* ให้หัวตารางแสดงทุกหน้า */
        }

        th {
            background-color: #2E4053;
            color: white;
            padding: 5px;
            border: 0.5px solid #000;
            font-weight: bold;
            text-align: center;
        }

        td {
            padding: 4px;
            border: 0.5px solid #000;
            text-align: center;
            vertical-align: top;
        }

        .text-left { text-align: left; }
        .text-red { color: #C0392B; }
        .text-green { color: #196F3D; }
        
        /* สลับสีบรรทัด (optional) */
        tr.even { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="header_content">
        <h1 style="font-size: 16px; margin: 0;">รายงานสรุปการจัดส่งสินค้า (Daily Jobs Report)</h1>
        <div style="font-size: 12px; margin-top: 5px;">
            <strong>วันที่เอกสาร:</strong> {{ po_date }} 
            &nbsp;|&nbsp; 
            <span style="color: gray;">พิมพ์เมื่อ: {{ print_date }}</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th width="5%">คันที่</th>
                <th width="10%">ทะเบียน</th>
                <th width="12%">คนขับ</th>
                <th width="8%">เวลาโหลด</th>
                <th width="15%">ปลายทาง</th>
                <th>1.เข้า</th>
                <th>2.เริ่ม</th>
                <th>3.เสร็จ</th>
                <th>6.ออก</th>
                <th>7.ถึงสาขา</th>
                <th>8.จบงาน</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
                {# Logic ตรวจสอบแถวซ้ำ #}
                {% set is_same = False %}
                {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.Round == job.Round %}
                    {% set is_same = True %}
                {% endif %}
                
                {# Logic ตรวจสอบแถวจบกลุ่มเพื่อตีเส้นใต้ (xhtml2pdf ทำ border-bottom เฉพาะ cell ได้ดีกว่า) #}
                {% set is_group_end = False %}
                {% if loop.last or (job.Car_No != loop.nextitem.Car_No) or (job.PO_Date != loop.nextitem.PO_Date) %}
                    {% set is_group_end = True %}
                {% endif %}
                
                {% set border_style = "border-bottom: 2px solid #000;" if is_group_end else "" %}

                <tr>
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.Car_No }}{% endif %}</td>
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.Plate }}{% endif %}</td>
                    <td class="text-left" style="{{ border_style }}">{% if not is_same %}{{ job.Driver }}{% endif %}</td>
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.Round }}{% endif %}</td>
                    <td class="text-left" style="{{ border_style }}">{{ job.Branch_Name }}</td>
                    
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.T1_Enter }}{% endif %}</td>
                    
                    <td style="{{ border_style }}">
                        {% if not is_same %}
                            {% if job.is_late %}
                                <div class="text-red">
                                    {{ job.T2_StartLoad }}<br>
                                    <span style="font-size: 8px;">{{ job.delay_msg }}</span>
                                </div>
                            {% else %}
                                <div class="{{ 'text-green' if job.T2_StartLoad else '' }}">
                                    {{ job.T2_StartLoad }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </td>
                    
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.T3_EndLoad }}{% endif %}</td>
                    <td style="{{ border_style }}">{% if not is_same %}{{ job.T6_Exit }}{% endif %}</td>
                    
                    <td style="background-color: #D5F5E3; {{ border_style }}">{{ job.T7_ArriveBranch }}</td>
                    <td style="background-color: #FADBD8; {{ border_style }}">{{ job.T8_EndJob }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>