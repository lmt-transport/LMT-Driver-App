{% extends "layout.html" %}
{% block content %}

<div class="max-w-7xl mx-auto pb-10">
    
    <div class="grid grid-cols-6 gap-3 mb-6"> <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
            <div class="text-gray-500 text-xs font-bold uppercase">เที่ยววิ่งทั้งหมด</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_trips }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-700">
            <div class="text-gray-500 text-xs font-bold uppercase">เที่ยววิ่งที่จบแล้ว</div>
            <div class="text-2xl font-bold text-green-700">{{ completed_trips }}</div>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-400">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาทั้งหมด</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_branches }}</div> </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาที่จบแล้ว</div>
            <div class="text-2xl font-bold text-green-600">{{ total_done_jobs }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาที่กำลังวิ่ง</div>
            <div class="text-2xl font-bold text-yellow-600">{{ total_running_jobs }}</div>
        </div>

        <div class="bg-indigo-600 p-4 rounded-xl shadow-sm text-white flex flex-col justify-center items-center cursor-pointer hover:bg-indigo-700 active:scale-95 transition group" onclick="copyCustomerLink()">
            <div class="text-xs opacity-80 group-hover:opacity-100"><i class="fa-solid fa-share-nodes"></i> ลิงค์สำหรับลูกค้า</div>
            <div class="font-bold text-sm mt-1 flex items-center gap-2">
                คลิกคัดลอก <i class="fa-regular fa-copy"></i>
            </div>
        </div>
    </div>

    <div class="flex space-x-2 mb-6 overflow-x-auto no-scrollbar pb-1">
        <button onclick="switchTab('tab-monitor')" id="btn-monitor" class="tab-btn flex-1 py-3 px-4 bg-indigo-600 text-white rounded-lg shadow font-medium transition hover:bg-indigo-700 whitespace-nowrap">
            <i class="fa-solid fa-satellite-dish mr-2"></i> ติดตามงาน (Monitor)
        </button>
        <button onclick="switchTab('tab-create')" id="btn-create" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap">
            <i class="fa-solid fa-plus-circle mr-2"></i> สร้างงานใหม่
        </button>
        <button onclick="switchTab('tab-report')" id="btn-report" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap">
            <i class="fa-solid fa-table mr-2"></i> รายงาน (Excel Report)
        </button>
    </div>

    <div id="tab-monitor" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700"><i class="fa-solid fa-list-check"></i> สถานะงาน Real-time</h3>
                <a href="/manager" class="text-sm text-indigo-600 hover:text-indigo-800 transition flex items-center gap-1">
                    <i class="fa-solid fa-arrows-rotate"></i> อัปเดตข้อมูล
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                        <tr>
                            <th class="px-4 py-3">สถานะ</th>
                            <th class="px-4 py-3">PO / คันที่</th>
                            <th class="px-4 py-3">คนขับ / ทะเบียน</th>
                            <th class="px-4 py-3">สาขาปลายทาง</th>
                            <th class="px-4 py-3 text-center w-1/3">Timeline & พิกัด</th>
                            <th class="px-4 py-3 text-center">จบงาน</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for job in jobs %}
                        <tr class="hover:bg-indigo-50/30 transition job-row" data-status="{{ job.Status }}">
                            <td class="px-4 py-3">
                                {% if job.Status == 'Done' %}
                                    <span class="inline-flex items-center gap-1 bg-green-100 text-green-800 text-xs font-bold px-2.5 py-0.5 rounded-full border border-green-200">
                                        <i class="fa-solid fa-check"></i> เสร็จ
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-800 text-xs font-bold px-2.5 py-0.5 rounded-full border border-yellow-200 animate-pulse">
                                        <i class="fa-solid fa-truck-fast"></i> วิ่งอยู่
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="font-bold text-gray-800">{{ job.PO_Date }}</div>
                                <div class="text-xs text-gray-500">คันที่ #{{ job.Car_No }} <span class="text-gray-300">|</span> รอบ {{ job.Round }}</div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900">{{ job.Driver }}</div>
                                <div class="text-xs text-gray-500 bg-gray-100 inline-block px-1.5 py-0.5 rounded mt-1">{{ job.Plate }}</div>
                            </td>
                            <td class="px-4 py-3 text-indigo-700 font-medium">{{ job.Branch_Name }}</td>
                            <td class="px-4 py-3">
                                <div class="flex flex-wrap gap-1 justify-center text-[10px]">
                                    {% macro map_link(time_val, loc_val, label, css='bg-gray-100 text-gray-600 border-gray-200') %}
                                        {% if time_val %}
                                            {% if loc_val %}
                                                <a href="https://www.google.com/maps/search/?api=1&query={{ loc_val }}" target="_blank" 
                                                   class="flex items-center gap-1 px-1.5 py-0.5 rounded border bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100 transition shadow-sm"
                                                   title="{{ label }} (คลิกดูแผนที่)">
                                                   {{ time_val }} <i class="fa-solid fa-location-dot text-[8px]"></i>
                                                </a>
                                            {% else %}
                                                <span class="px-1.5 py-0.5 rounded border {{ css }} cursor-default" title="{{ label }}">
                                                    {{ time_val }}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    {% endmacro %}
                                    {{ map_link(job.T1_Enter, job.L1_Loc, 'เข้าโรงงาน') }}
                                    {{ map_link(job.T2_StartLoad, job.L2_Loc, 'เริ่มโหลด') }}
                                    {{ map_link(job.T3_EndLoad, job.L3_Loc, 'โหลดเสร็จ') }}
                                    {{ map_link(job.T6_Exit, job.L6_Loc, 'ออกโรงงาน') }}
                                    {{ map_link(job.T7_ArriveBranch, job.L7_Loc, 'ถึงสาขา', 'bg-green-50 text-green-700 border-green-200') }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-center font-bold">
                                {% if job.T8_EndJob %}
                                    {% if job.L8_Loc %}
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ job.L8_Loc }}" target="_blank" class="text-green-600 hover:text-green-800 hover:underline flex justify-center items-center gap-1">
                                        {{ job.T8_EndJob }} <i class="fa-solid fa-map-location-dot text-xs"></i>
                                    </a>
                                    {% else %}
                                    <span class="text-green-600">{{ job.T8_EndJob }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-300">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if jobs|length == 0 %}
                <div class="p-10 text-center text-gray-400 bg-gray-50">
                    <i class="fa-regular fa-folder-open text-4xl mb-3 opacity-30"></i><br>
                    ยังไม่มีข้อมูลงานในขณะนี้
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="tab-create" class="tab-content hidden">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-indigo-600"></i> สร้างใบงานใหม่
            </h3>
            
            <form action="/create_job" method="POST" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ (PO Date)</label>
                        <input type="date" name="po_date" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">รอบโหลด</label>
                        <input type="time" name="round_time" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border bg-gray-50">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">คันที่</label>
                        <input type="number" name="car_no" placeholder="เช่น 1" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">คนขับ</label>
                        <select id="driver_select" name="driver_name" onchange="updatePlate()" required class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border">
                            <option value="">-- เลือกคนขับ --</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.Name }}" data-plate="{{ driver.Plate_License }}">{{ driver.Name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="bg-gray-100 p-2 rounded-lg flex items-center gap-2 text-sm text-gray-600 border border-gray-200">
                    <i class="fa-solid fa-car-side"></i> ทะเบียนรถ: 
                    <input type="text" id="plate_input" name="plate_license" readonly class="bg-transparent font-bold text-gray-800 w-full focus:outline-none" placeholder="(เลือกชื่อคนขับเพื่อแสดง)">
                </div>
                
                <hr class="border-gray-100">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">รายชื่อสาขาปลายทาง (เรียงตามลำดับส่ง)</label>
                    <div id="branch-container" class="space-y-3">
                        <div class="flex gap-2">
                            <span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">1</span>
                            <input type="text" name="branches" placeholder="ระบุชื่อสาขาที่ 1" required class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border">
                        </div>
                    </div>
                    <button type="button" onclick="addBranchField()" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1 transition">
                        <i class="fa-solid fa-circle-plus text-lg"></i> เพิ่มสาขาถัดไป
                    </button>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition shadow-lg transform active:scale-[0.99] flex justify-center items-center gap-2">
                        <i class="fa-solid fa-save"></i> บันทึกงานทั้งหมด
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">
                    <div class="bg-green-100 p-2 rounded text-green-700"><i class="fa-solid fa-file-csv"></i></div> 
                    สรุปรายงานประจำวัน
                </h3>
                
                <form method="GET" action="/manager" class="flex flex-wrap gap-2 w-full md:w-auto items-center justify-end">
                    <input type="hidden" name="tab" value="report">
                    <select name="date_filter" id="report_date_filter" class="rounded-lg border border-gray-300 p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none shadow-sm">
                        <option value="">-- เลือกวันที่ PO --</option>
                        {% for d in all_dates %}
                        <option value="{{ d }}" {% if request.args.get('date_filter') == d %}selected{% endif %}>{{ d }}</option>
                        {% endfor %}
                    </select>
                    
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-bold shadow transition">
                        ค้นหา
                    </button>
                    
                    <a href="#" onclick="triggerExport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-bold shadow transition flex items-center gap-2">
                        <i class="fa-solid fa-file-excel"></i> Export Excel
                    </a>

                    <a href="/manager?tab=report" class="bg-white text-gray-500 border border-gray-300 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm shadow-sm" title="รีเซ็ต">
                        <i class="fa-solid fa-rotate-right"></i>
                    </a>
                </form>
            </div>

            <div class="border rounded-lg overflow-hidden overflow-x-auto shadow-inner bg-gray-500">
                <table class="w-full text-xs text-center border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="text-white">
                            <th class="p-3 bg-green-700 border-r border-green-600 sticky left-0 z-10 shadow-lg">ลำดับรถ</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">PO Date</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">เวลาโหลด</th>
                            <th class="p-3 bg-green-600 border-r border-green-500 min-w-[150px]">ปลายทาง (สาขา)</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">ทะเบียนรถ</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">ชื่อคนขับ</th>
                            
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">1.เข้าโรงงาน</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">2.เริ่มโหลด</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">3.โหลดเสร็จ</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">4.ยื่นเอกสาร</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">5.รับเอกสาร</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">6.ออกโรงงาน</th>
                            
                            <th class="p-3 bg-[#9bbb59] border-r border-[#8aa64f]">7.ถึงสาขา</th>
                            <th class="p-3 bg-[#9bbb59]">8.จบงาน</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 bg-white">
                        {% if jobs|length == 0 %}
                            <tr><td colspan="14" class="p-10 text-center text-gray-400">กรุณาเลือกวันที่ หรือ ไม่พบข้อมูล</td></tr>
                        {% else %}
                            
                            {% for job in jobs %}
                                {% set is_same = False %}
                                {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.PO_Date == job.PO_Date %}
                                    {% set is_same = True %}
                                {% endif %}

                                {% set start_load_color = '' %}
                                {% if job.T2_StartLoad and job.Round %}
                                    {% set actual = job.T2_StartLoad %}
                                    {% set planned = job.Round %}
                                    {% if actual > planned %}
                                        {% set start_load_color = 'text-red-600 font-bold' %}
                                    {% else %}
                                        {% set start_load_color = 'text-green-600 font-bold' %}
                                    {% endif %}
                                {% endif %}

                                <tr class="border-b hover:bg-gray-50 transition">
                                    <td class="p-2 border-r font-bold bg-gray-50 sticky left-0 z-10 border-gray-200">
                                        {% if not is_same %} คันที่ {{ job.Car_No }} {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">{% if not is_same %}{{ job.PO_Date }}{% endif %}</td>
                                    <td class="p-2 border-r border-gray-200">{% if not is_same %}{{ job.Round }}{% endif %}</td>
                                    
                                    <td class="p-2 border-r border-gray-200 text-left pl-4 font-bold text-indigo-700">{{ job.Branch_Name }}</td>
                                    
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %} {{ job.Plate }} {% endif %}
                                    </td>
                                    
                                    <td class="p-2 border-r border-gray-200 font-medium">
                                        {% if not is_same %} {{ job.Driver }} {% endif %}
                                    </td>

                                    {% if is_same %}
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                        <td class="p-2 border-r bg-gray-50/50 border-gray-100"></td>
                                    {% else %}
                                        <td class="p-2 border-r border-gray-200">{{ job.T1_Enter }}</td>
                                        <td class="p-2 border-r border-gray-200 {{ start_load_color }}">{{ job.T2_StartLoad }}</td> <td class="p-2 border-r border-gray-200">{{ job.T3_EndLoad }}</td>
                                        <td class="p-2 border-r border-gray-200">{{ job.T4_SubmitDoc }}</td>
                                        <td class="p-2 border-r border-gray-200">{{ job.T5_RecvDoc }}</td>
                                        <td class="p-2 border-r border-gray-200">{{ job.T6_Exit }}</td>
                                    {% endif %}

                                    <td class="p-2 border-r font-bold text-green-700 bg-green-50/50 border-gray-200">{{ job.T7_ArriveBranch }}</td>
                                    <td class="p-2 font-bold text-red-600 bg-red-50/50">{{ job.T8_EndJob }}</td>
                                </tr>
                            {% endfor %}

                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="mt-2 text-right text-[10px] text-gray-400">
                Data refreshed at: <span id="report-time"></span>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Tab Switching System
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow');
            btn.classList.add('bg-white', 'text-gray-600');
        });
        document.getElementById(tabId).classList.remove('hidden');
        let btn = document.getElementById(tabId.replace('tab-', 'btn-'));
        btn.classList.remove('bg-white', 'text-gray-600');
        btn.classList.add('bg-indigo-600', 'text-white', 'shadow');
        localStorage.setItem('activeTab', tabId);
    }

    // 2. Auto-Fill License Plate
    function updatePlate() {
        const select = document.getElementById('driver_select');
        const selectedOption = select.options[select.selectedIndex];
        const plate = selectedOption.getAttribute('data-plate');
        const plateInput = document.getElementById('plate_input');
        
        if(plate) {
            plateInput.value = plate;
        } else {
            plateInput.value = "";
        }
    }

    // 3. Dynamic Branch Fields
    function addBranchField() {
        const container = document.getElementById('branch-container');
        const count = container.children.length + 1;
        
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `
            <span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">${count}</span>
            <input type="text" name="branches" placeholder="ระบุชื่อสาขาที่ ${count}" required class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2 transition"><i class="fa-solid fa-trash"></i></button>
        `;
        
        container.appendChild(div);
    }

    // 4. Copy Customer Link
    function copyCustomerLink() {
        let url = window.location.origin + "/tracking";
        navigator.clipboard.writeText(url).then(() => {
            alert("✅ คัดลอกลิงค์สำหรับลูกค้าแล้ว:\n" + url + "\n\nส่งให้ลูกค้าได้เลยครับ!");
        }).catch(err => {
            alert("ไม่สามารถคัดลอกได้: " + err);
        });
    }

    // 5. JavaScript สำหรับ Trigger Export
    function triggerExport() {
        const selectedDate = document.getElementById('report_date_filter').value;
        let url = '/export_excel';

        if (selectedDate) {
            url += `?date_filter=${selectedDate}`;
        }
        
        window.open(url, '_blank');
    }

    // 6. Initialize Page
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        const savedTab = localStorage.getItem('activeTab') || 'tab-monitor';
        
        if(tabParam) {
            switchTab('tab-' + tabParam);
        } else {
            switchTab(savedTab);
        }

        document.getElementById('report-time').innerText = new Date().toLocaleString('th-TH');
    });
</script>

{% endblock %}