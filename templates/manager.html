{% extends "layout.html" %}
{% block content %}

<style>
    body, h1, h2, h3, h4, h5, h6, p, span, div, table, input, select, button, textarea {
        font-family: 'Kanit', sans-serif !important;
    }
    .table-data { font-size: 0.8rem; } 
    .table-header { font-size: 0.75rem; }
    
    .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; 
    }
    
    .modal { transition: opacity 0.25s ease; }
    body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
</style>

<div class="w-full max-w-[99%] mx-auto pb-10">
    
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
            <div class="text-gray-500 text-xs font-bold uppercase">เที่ยววิ่งทั้งหมด</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_trips }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-700">
            <div class="text-gray-500 text-xs font-bold uppercase">เที่ยววิ่งที่จบแล้ว</div>
            <div class="text-2xl font-bold text-green-700">{{ completed_trips }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-400">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาทั้งหมด</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_branches }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาที่จบแล้ว</div>
            <div class="text-2xl font-bold text-green-600">{{ total_done_jobs }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
            <div class="text-gray-500 text-xs font-bold uppercase">สาขาที่กำลังวิ่ง</div>
            <div class="text-2xl font-bold text-yellow-600">{{ total_running_jobs }}</div>
        </div>
        <div class="bg-indigo-600 p-4 rounded-xl shadow-sm text-white flex flex-col justify-center items-center cursor-pointer hover:bg-indigo-700 active:scale-95 transition group" onclick="copyCustomerLink()">
            <div class="text-xs opacity-80 group-hover:opacity-100"><i class="fa-solid fa-share-nodes"></i> ลิงค์สำหรับลูกค้า</div>
            <div class="font-bold text-sm mt-1 flex items-center gap-2">คลิกคัดลอก <i class="fa-regular fa-copy"></i></div>
        </div>
    </div>

    <div class="flex space-x-2 mb-6 overflow-x-auto no-scrollbar pb-1">
        <button onclick="switchTab('tab-monitor')" id="btn-monitor" class="tab-btn flex-1 py-3 px-4 bg-indigo-600 text-white rounded-lg shadow font-medium transition hover:bg-indigo-700 whitespace-nowrap text-sm"><i class="fa-solid fa-satellite-dish mr-2"></i> ติดตามงาน (Monitor)</button>
        <button onclick="switchTab('tab-drivers')" id="btn-drivers" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap text-sm"><i class="fa-solid fa-id-card mr-2"></i> สรุปงานคนขับ (Dashboard)</button>
        <button onclick="switchTab('tab-create')" id="btn-create" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap text-sm"><i class="fa-solid fa-plus-circle mr-2"></i> สร้างงานใหม่</button>
        <button onclick="switchTab('tab-report')" id="btn-report" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap text-sm"><i class="fa-solid fa-table mr-2"></i> รายงาน (Excel Report)</button>
    </div>

    <div id="tab-monitor" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
            <div class="p-4 border-b flex flex-wrap justify-between items-center bg-gray-50 gap-3">
                <h3 class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                    <i class="fa-solid fa-list-check text-indigo-600"></i> สถานะงาน
                </h3>
                <form method="GET" action="/manager" class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-gray-300 shadow-sm">
                    <input type="hidden" name="tab" value="monitor">
                    <a href="/manager?tab=monitor&date_filter={{ prev_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-r border-gray-200"><i class="fa-solid fa-chevron-left"></i></a>
                    <span class="text-xs font-bold text-gray-500 pl-1">PO:</span>
                    <input type="date" name="date_filter" value="{{ current_filter_date }}" onchange="this.form.submit()" class="text-sm border-none focus:ring-0 cursor-pointer font-medium text-gray-700 h-8 bg-transparent">
                    <a href="/manager?tab=monitor&date_filter={{ next_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-l border-gray-200"><i class="fa-solid fa-chevron-right"></i></a>
                    <a href="/manager?tab=monitor" class="text-gray-400 hover:text-indigo-600 px-2 border-l border-gray-200"><i class="fa-solid fa-rotate-right"></i></a>
                </form>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left text-gray-600 table-data">
                    <thead class="text-gray-700 uppercase bg-gray-100 border-b table-header">
                        <tr>
                            <th class="px-4 py-3 text-center">สถานะ</th>
                            <th class="px-4 py-3">PO Date / วันที่โหลด</th>
                            <th class="px-4 py-3">เที่ยววิ่ง (คันที่)</th>
                            <th class="px-4 py-3">คนขับ / ทะเบียน</th>
                            <th class="px-4 py-3 text-center">เวลาโหลด</th>
                            <th class="px-4 py-3 text-center">เข้าโรงงาน</th>
                            <th class="px-4 py-3 text-center">ออกโรงงาน</th>
                            <th class="px-4 py-3 text-center">จบงาน (ล่าสุด)</th>
                            <th class="px-4 py-3 text-center">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% if jobs|length == 0 %}
                            <tr><td colspan="9" class="p-10 text-center text-gray-400">ไม่พบข้อมูลงานในวันที่เลือก</td></tr>
                        {% endif %}
                        
                        <script>
                            const driverData = {};
                            {% for d in drivers %}
                                driverData["{{ d.Name }}"] = {
                                    plate: "{{ d.Plate_License }}",
                                    id_card: "{{ d.get('ID_Card', '-') }}",
                                    phone: "{{ d.get('Phone', '-') }}"
                                };
                            {% endfor %}
                        </script>

                        {% for job in jobs %}
                            {% if loop.first or (loop.previtem.Car_No != job.Car_No or loop.previtem.PO_Date != job.PO_Date or loop.previtem.Round != job.Round) %}
                                {% set trip_key_tuple = (job.PO_Date|string, job.Car_No|string, job.Round|string) %}
                                {% set last_end_time = trip_last_end_time.get(trip_key_tuple, "") %}
                                
                                {% set status_badge = '<span class="inline-flex items-center gap-1 bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded-full border border-gray-300">ยังไม่ถึงคลัง</span>' %}
                                {% if last_end_time %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-flag-checkered"></i> จบงาน</span>' %}
                                {% elif job.T6_Exit %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full border border-blue-200"><i class="fa-solid fa-truck-fast"></i> กำลังออกส่ง</span>' %}
                                {% elif job.T1_Enter %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full border border-indigo-200"><i class="fa-solid fa-warehouse"></i> ถึงคลังแล้ว</span>' %}
                                {% endif %}
                                
                                {% set trip_branches = [] %}
                                {% for j in jobs %}
                                    {% if j.PO_Date == job.PO_Date and j.Car_No == job.Car_No and j.Round == job.Round %}
                                        {% set _ = trip_branches.append(j.Branch_Name) %}
                                    {% endif %}
                                {% endfor %}
                                
                                <tr class="hover:bg-indigo-50/30 transition group/row">
                                    <td class="px-4 py-3 text-center">{{ status_badge | safe }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="font-bold text-gray-800">{{ job.PO_Date | thai_date }}</div>
                                        {% set show_load = job.get('Load_Date', job.PO_Date) %}
                                        <div class="text-xs text-blue-600 font-medium bg-blue-50 px-1 rounded inline-block mt-0.5">โหลด: {{ show_load | thai_date }}</div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap font-bold text-gray-800">
                                        คันที่ #{{ job.Car_No }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">{{ job.Driver }}</div>
                                        <div class="text-xs text-gray-500 bg-gray-100 inline-block px-1.5 py-0.5 rounded mt-1">{{ job.Plate }}</div>
                                    </td>
                                    <td class="px-4 py-3 text-center font-bold text-indigo-700 text-base">{{ job.Round }}</td>
                                    <td class="px-4 py-3 text-center">{% if job.T1_Enter %}<span class="text-indigo-600 font-bold">{{ job.T1_Enter }}</span>{% else %}<span class="text-gray-300">-</span>{% endif %}</td>
                                    <td class="px-4 py-3 text-center">{% if job.T6_Exit %}<span class="text-blue-600 font-bold">{{ job.T6_Exit }}</span>{% else %}<span class="text-gray-300">-</span>{% endif %}</td>
                                    <td class="px-4 py-3 text-center">{% if last_end_time %}<span class="text-green-600 font-bold">{{ last_end_time }}</span>{% else %}<span class="text-gray-300">-</span>{% endif %}</td>
                                    <td class="px-4 py-3 text-center flex justify-center gap-2 items-center">
                                        {% if job.L1_Loc %}
                                            <a href="https://www.google.com/maps/search/?api=1&query={{ job.L1_Loc }}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 transition shadow-sm" title="ดูพิกัด"><i class="fa-solid fa-location-dot"></i></a>
                                        {% endif %}
                                        
                                        {% set modal_info = {
                                            'carNo': job.Car_No,
                                            'poDate': job.PO_Date | thai_date,
                                            'loadDate': show_load | thai_date,
                                            'roundTime': job.Round,
                                            'branches': trip_branches,
                                            'oldDriver': job.Driver,
                                            'oldPlate': job.Plate
                                        } %}
                                        <button 
                                            data-info='{{ modal_info | tojson | forceescape }}'
                                            onclick="openChangeDriverModal(this)"
                                            class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-orange-50 text-orange-500 hover:bg-orange-100 hover:text-orange-700 transition shadow-sm" title="แจ้งเปลี่ยนคนขับ/ทะเบียน">
                                            <i class="fa-solid fa-right-left"></i>
                                        </button>

                                        <form action="/delete_job" method="POST" onsubmit="return confirm('⚠️ ยืนยันการลบเที่ยววิ่งนี้?');">
                                            <input type="hidden" name="po_date" value="{{ job.PO_Date }}">
                                            <input type="hidden" name="round_time" value="{{ job.Round }}">
                                            <input type="hidden" name="car_no" value="{{ job.Car_No }}">
                                            <button type="submit" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-700 transition shadow-sm" title="ลบงาน"><i class="fa-solid fa-trash-can"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-drivers" class="tab-content hidden">
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 md:p-6 shadow-inner">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-800 text-xl flex items-center gap-2">
                    <div class="bg-indigo-100 p-2 rounded text-indigo-700"><i class="fa-solid fa-users-viewfinder"></i></div> 
                    สรุปงานรายบุคคล (PO: {{ current_filter_date | thai_date }})
                </h3>
            </div>

            <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-user-clock text-green-500"></i> พนักงานที่ว่างงาน (Available)
                </h4>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2 border-b border-yellow-200 pb-2">
                            <i class="fa-solid fa-sun text-yellow-500 text-lg"></i>
                            <span class="font-bold text-yellow-800 text-sm">กะเช้า (Day Only)</span>
                            <span class="ml-auto bg-white text-yellow-600 text-xs font-bold px-2 py-0.5 rounded-full border border-yellow-200">{{ idle_drivers_day|length }}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                            {% for d in idle_drivers_day %}
                                <span class="text-xs bg-white border border-yellow-200 text-gray-700 px-2 py-1 rounded shadow-sm">{{ d.Name }}</span>
                            {% else %}
                                <span class="text-xs text-gray-400 italic">- ว่าง -</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2 border-b border-indigo-200 pb-2">
                            <i class="fa-solid fa-moon text-indigo-500 text-lg"></i>
                            <span class="font-bold text-indigo-800 text-sm">กะดึก (Night Only)</span>
                            <span class="ml-auto bg-white text-indigo-600 text-xs font-bold px-2 py-0.5 rounded-full border border-indigo-200">{{ idle_drivers_night|length }}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                            {% for d in idle_drivers_night %}
                                <span class="text-xs bg-white border border-indigo-200 text-gray-700 px-2 py-1 rounded shadow-sm">{{ d.Name }}</span>
                            {% else %}
                                <span class="text-xs text-gray-400 italic">- ว่าง -</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2 border-b border-purple-200 pb-2">
                            <i class="fa-solid fa-repeat text-purple-500 text-lg"></i>
                            <span class="font-bold text-purple-800 text-sm">วิ่งได้ทั้งวัน (Hybrid)</span>
                            <span class="ml-auto bg-white text-purple-600 text-xs font-bold px-2 py-0.5 rounded-full border border-purple-200">{{ idle_drivers_hybrid|length }}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                            {% for d in idle_drivers_hybrid %}
                                <span class="text-xs bg-white border border-purple-200 text-gray-700 px-2 py-1 rounded shadow-sm">{{ d.Name }}</span>
                            {% else %}
                                <span class="text-xs text-gray-400 italic">- ว่าง -</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-2 border-b border-gray-200 pb-2">
                            <i class="fa-solid fa-user-tag text-gray-400 text-lg"></i>
                            <span class="font-bold text-gray-600 text-sm">พนักงานใหม่/ไม่ระบุ</span>
                            <span class="ml-auto bg-white text-gray-500 text-xs font-bold px-2 py-0.5 rounded-full border border-gray-200">{{ idle_drivers_new|length }}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                            {% for d in idle_drivers_new %}
                                <span class="text-xs bg-white border border-gray-200 text-gray-500 px-2 py-1 rounded shadow-sm">{{ d.Name }}</span>
                            {% else %}
                                <span class="text-xs text-gray-400 italic">- ว่าง -</span>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>

            {% if driver_stats|length == 0 %}
                <div class="text-center py-10 text-gray-400">
                    <i class="fa-solid fa-user-slash text-4xl mb-3 opacity-50"></i>
                    <p>ไม่พบข้อมูลงานคนขับในวันนี้</p>
                </div>
            {% else %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    {% for driver_name, stats in driver_stats.items() %}
                    
                    {# --- Calculate Shift Flags for Header --- #}
                    {% set ns = namespace(has_day=false, has_night=false) %}
                    {% for r in stats.rounds %}
                        {% set h = r.round.split(':')[0]|int %}
                        {% if h >= 6 and h <= 18 %}
                            {% set ns.has_day = true %}
                        {% else %}
                            {% set ns.has_night = true %}
                        {% endif %}
                    {% endfor %}
                    {# ---------------------------------------- #}

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition duration-200">
                        <div class="bg-gradient-to-r from-slate-700 to-slate-800 p-4 flex justify-between items-center text-white">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                                    <i class="fa-solid fa-user-astronaut text-lg"></i>
                                </div>
                                <div class="truncate font-bold text-sm">{{ driver_name }}</div>
                            </div>
                            
                            <div class="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm flex items-center gap-1.5">
                                {% if ns.has_day %}
                                    <i class="fa-solid fa-sun text-yellow-300"></i>
                                {% endif %}
                                {% if ns.has_night %}
                                    <i class="fa-solid fa-moon text-indigo-100"></i>
                                {% endif %}
                                <span>{{ stats.total_trips }} เที่ยว</span>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-white space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                            {% for round in stats.rounds %}
                            
                            {# --- Calculate Round Shift for Detail --- #}
                            {% set h_round = round.round.split(':')[0]|int %}
                            {% set is_day_round = (h_round >= 6 and h_round <= 18) %}
                            {# ---------------------------------------- #}

                            <div class="border border-gray-100 rounded-lg p-3 bg-gray-50 relative group">
                                <div class="absolute top-2 right-2">
                                    {% if round.status == 'Done' %}
                                        <span class="text-green-500 text-[10px]"><i class="fa-solid fa-circle-check"></i> จบ</span>
                                    {% else %}
                                        <span class="text-gray-400 text-[10px]"><i class="fa-solid fa-clock"></i> รอ</span>
                                    {% endif %}
                                </div>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-indigo-600 text-white text-xs font-bold px-2 py-0.5 rounded shadow-sm">
                                        คันที่ #{{ round.car_no }}
                                    </span>
                                    <span class="text-xs text-gray-500 font-mono bg-white border px-1.5 py-0.5 rounded flex items-center gap-1">
                                        {{ round.round }} น.
                                        {% if is_day_round %}
                                            <i class="fa-solid fa-sun text-yellow-500"></i>
                                        {% else %}
                                            <i class="fa-solid fa-moon text-indigo-500"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                
                                <div class="text-xs text-gray-600 mb-1">
                                    <i class="fa-solid fa-truck"></i> {{ round.plate }}
                                </div>
                                
                                <div class="text-xs text-gray-500 mt-2 border-t border-gray-200 pt-2">
                                    {% for branch in round.branches %}
                                    <div class="truncate flex items-start gap-1">
                                        <i class="fa-solid fa-location-dot text-red-400 mt-0.5 text-[8px]"></i> {{ branch }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <div id="tab-create" class="tab-content hidden">
         <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-indigo-600"></i> สร้างใบงานใหม่</h3>
            <form action="/create_job" method="POST" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่เอกสาร (PO Date)</label>
                        <input type="date" name="po_date" id="po_date_input" required onchange="autoSetLoadDate()"
                               class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            วันที่เข้าโหลดจริง <span class="text-xs text-indigo-500 font-normal">(Auto: PO -1 วัน)</span>
                        </label>
                        <input type="date" name="load_date" id="load_date_input" required 
                               class="w-full rounded-lg border-indigo-200 shadow-sm p-2.5 border bg-indigo-50/30 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">รอบโหลด (เวลา)</label><input type="time" name="round_time" required class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border bg-gray-50"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ลำดับคันที่</label><input type="number" name="car_no" placeholder="1" required class="w-full rounded-lg border-gray-300 p-2.5 border bg-gray-50"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">น้ำหนัก (Kg)</label><input type="text" name="weight" placeholder="ระบุน้ำหนัก" class="w-full rounded-lg border-gray-300 p-2.5 border bg-gray-50"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">คนขับ</label>
                    <select id="driver_select" name="driver_name" onchange="updatePlate()" required class="w-full rounded-lg border-gray-300 p-2.5 border">
                        <option value="">-- เลือก --</option>
                        {% for driver in drivers %}
                        <option value="{{ driver.Name }}" data-plate="{{ driver.Plate_License }}">{{ driver.Name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg flex items-center gap-2 text-sm text-gray-600 border border-gray-200"><i class="fa-solid fa-car-side"></i> ทะเบียนรถ: <input type="text" id="plate_input" name="plate_license" readonly class="bg-transparent font-bold text-gray-800 w-full focus:outline-none"></div>
                <hr class="border-gray-100">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">สาขาปลายทาง</label>
                    <div id="branch-container" class="space-y-3">
                        <div class="flex gap-2">
                            <span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">1</span>
                            <input type="text" name="branches" placeholder="สาขาที่ 1" required class="flex-1 rounded-lg border-gray-300 p-2.5 border">
                        </div>
                    </div>
                    <button type="button" onclick="addBranchField()" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1 transition"><i class="fa-solid fa-circle-plus text-lg"></i> เพิ่มสาขา</button>
                </div>
                <div class="pt-4"><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition shadow-lg">บันทึกงานทั้งหมด</button></div>
            </form>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><div class="bg-green-100 p-2 rounded text-green-700"><i class="fa-solid fa-file-csv"></i></div> สรุปรายงานประจำวัน</h3>
                <form method="GET" action="/manager" class="flex flex-wrap gap-2 w-full md:w-auto items-center justify-end">
                    <input type="hidden" name="tab" value="report">
                    <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-gray-300 shadow-sm">
                        <a href="/manager?tab=report&date_filter={{ prev_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-r border-gray-200"><i class="fa-solid fa-chevron-left"></i></a>
                        <span class="text-xs font-bold text-gray-500 pl-1">PO:</span>
                        <input type="date" name="date_filter" id="report_date_filter" value="{{ current_filter_date }}" onchange="this.form.submit()" class="text-sm border-none focus:ring-0 cursor-pointer font-medium text-gray-700 h-8 bg-transparent">
                        <a href="/manager?tab=report&date_filter={{ next_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-l border-gray-200"><i class="fa-solid fa-chevron-right"></i></a>
                    </div>
                    <a href="#" onclick="triggerCustomerPDF()" class="bg-red-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-red-700 transition shadow-md flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">PDF</span>
                    </a>
                    <a href="#" onclick="triggerCompactPDF()" class="bg-orange-500 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-orange-600 transition shadow-md flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-file-contract"></i> <span class="hidden sm:inline">Summary</span>
                    </a>
                    <a href="#" onclick="triggerExport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-bold shadow transition flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Excel</a>
                    <button type="button" onclick="shareLine('day')" class="bg-[#06C755] text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-[#05b34c] transition shadow-md flex items-center gap-1 transform active:scale-95" title="แผนงานกลางวัน">
                        <i class="fa-brands fa-line text-lg"></i> <i class="fa-solid fa-sun text-yellow-300"></i>
                    </button>
                    <button type="button" onclick="shareLine('night')" class="bg-[#06C755] text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-[#05b34c] transition shadow-md flex items-center gap-1 transform active:scale-95" title="แผนงานกลางคืน">
                        <i class="fa-brands fa-line text-lg"></i> <i class="fa-solid fa-moon text-indigo-100"></i>
                    </button>

                    <button type="button" onclick="copyUpdateText('day')" class="bg-blue-600 text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 transition shadow-md flex items-center gap-1 transform active:scale-95" title="อัพเดทสถานะกลางวัน">
                        <i class="fa-solid fa-bullhorn"></i> <i class="fa-solid fa-sun text-yellow-300"></i>
                    </button>
                    <button type="button" onclick="copyUpdateText('night')" class="bg-indigo-600 text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-md flex items-center gap-1 transform active:scale-95" title="อัพเดทสถานะกลางคืน">
                        <i class="fa-solid fa-bullhorn"></i> <i class="fa-solid fa-moon text-indigo-100"></i>
                    </button>
                    <a href="/manager?tab=report" class="bg-white text-gray-500 border border-gray-300 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm shadow-sm"><i class="fa-solid fa-rotate-right"></i></a>
                </form>
            </div>

            <div class="border rounded-lg overflow-hidden overflow-x-auto shadow-inner bg-gray-500 custom-scrollbar">
                <table class="w-full text-center border-collapse whitespace-nowrap table-data">
                    <thead>
                        <tr class="text-white table-header font-bold tracking-wide">
                            <th class="px-2 py-2 bg-green-700 border-r border-green-600 sticky left-0 z-10 shadow-lg">ลำดับ</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500">PO Date</th>
                            <th class="px-2 py-2 bg-blue-600 border-r border-blue-500">Load Date</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500">เวลา</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500 min-w-[150px]">ปลายทาง (สาขา)</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500">น้ำหนัก</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500">ทะเบียน</th>
                            <th class="px-2 py-2 bg-green-600 border-r border-green-500">คนขับ</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">เข้าโรงงาน</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">เริ่มโหลด</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">โหลดเสร็จ</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">ยื่นเอกสาร</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">รับเอกสาร</th>
                            <th class="px-1 py-2 bg-[#c0504d] border-r border-[#a64d4d]">ออกโรงงาน</th>
                            <th class="px-2 py-2 bg-[#9bbb59] border-r border-[#8aa64f]">ถึงสาขา</th>
                            <th class="px-2 py-2 bg-[#9bbb59]">จบงาน</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 bg-white">
                        {% if jobs|length == 0 %}
                            <tr><td colspan="16" class="p-10 text-center text-gray-400">กรุณาเลือกวันที่ หรือ ไม่พบข้อมูล</td></tr>
                        {% else %}
                            {% macro report_time_cell(time_val, loc_val, text_class='') %}
                                {% if time_val %}
                                    {% if loc_val %}
                                        <a href="https://maps.google.com/maps?q={{ loc_val }}" target="_blank" class="inline-flex items-center justify-center gap-1 hover:bg-gray-100/80 px-1.5 py-0.5 rounded transition group cursor-pointer {{ text_class }}" title="ดูพิกัด">
                                            {{ time_val }} <i class="fa-solid fa-location-dot text-[9px] opacity-30 group-hover:opacity-100 group-hover:text-blue-600"></i>
                                        </a>
                                    {% else %}
                                        <span class="{{ text_class }}">{{ time_val }}</span>
                                    {% endif %}
                                {% endif %}
                            {% endmacro %}

                            {% for job in jobs %}
                                {% set is_same = False %}
                                {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.PO_Date == job.PO_Date %}
                                    {% set is_same = True %}
                                {% endif %}
                                
                                {% set start_load_color = '' %}
                                {% if job.T2_StartLoad %}
                                    {% if job.is_start_late %} 
                                        {% set start_load_color = 'text-red-600 font-bold' %}
                                    {% else %} 
                                        {% set start_load_color = 'text-green-600 font-bold' %} 
                                    {% endif %}
                                {% endif %}
                                
                                <tr class="border-b hover:bg-gray-50 transition">
                                    <td class="px-2 py-1 border-r font-bold bg-gray-50 sticky left-0 z-10 border-gray-200 text-indigo-900 text-center">{% if not is_same %} #{{ job.Car_No }} {% endif %}</td>
                                    <td class="px-2 py-1 border-r border-gray-200">{% if not is_same %}{{ job.PO_Date | thai_date }}{% endif %}</td>
                                    
                                    <td class="px-2 py-1 border-r border-gray-200 text-blue-700 font-bold bg-blue-50/20">
                                        {% if not is_same %}
                                            {% set show_load = job.get('Load_Date', job.PO_Date) %}
                                            {{ show_load | thai_date }}
                                        {% endif %}
                                    </td>

                                    <td class="px-2 py-1 border-r border-gray-200 font-bold">{% if not is_same %}{{ job.Round }}{% endif %}</td>
                                    <td class="px-2 py-1 border-r border-gray-200 text-left pl-2 font-bold text-indigo-700 truncate max-w-[200px]" title="{{ job.Branch_Name }}">{{ job.Branch_Name }}</td>
                                    <td class="px-2 py-1 border-r border-gray-200 text-center text-gray-600 font-medium">{% if not is_same %}{{ job.get('Weight', '-') | comma_format }}{% endif %}</td>
                                    <td class="px-2 py-1 border-r border-gray-200">{% if not is_same %} {{ job.Plate }} {% endif %}</td>
                                    <td class="px-2 py-1 border-r border-gray-200 font-medium truncate max-w-[120px]" title="{{ job.Driver }}">{% if not is_same %} {{ job.Driver }} {% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T1_Enter, job.L1_Loc) }}{% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T2_StartLoad, job.L2_Loc, start_load_color) }}{% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T3_EndLoad, job.L3_Loc) }}{% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T4_SubmitDoc, job.L4_Loc) }}{% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T5_RecvDoc, job.L5_Loc) }}{% endif %}</td>
                                    <td class="px-1 py-1 border-r border-gray-200">{% if not is_same %}{{ report_time_cell(job.T6_Exit, job.L6_Loc) }}{% endif %}</td>
                                    <td class="px-2 py-1 border-r font-bold text-green-700 bg-green-50/50 border-gray-200">{{ report_time_cell(job.T7_ArriveBranch, job.L7_Loc, 'text-green-800') }}</td>
                                    <td class="px-2 py-1 font-bold text-red-600 bg-red-50/50">{{ report_time_cell(job.T8_EndJob, job.L8_Loc, 'text-red-700') }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="mt-2 text-right text-[10px] text-gray-400">Data refreshed at: <span id="report-time"></span></div>
        </div>
    </div>
</div>

<div id="changeDriverModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="closeChangeDriverModal()"></div>
    
    <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3 border-b">
                <p class="text-xl font-bold text-gray-800"><i class="fa-solid fa-right-left text-orange-500"></i> แจ้งเปลี่ยนทะเบียนรถ/คนขับ</p>
                <div class="cursor-pointer z-50" onclick="closeChangeDriverModal()">
                    <i class="fa-solid fa-xmark text-2xl text-gray-500 hover:text-gray-700"></i>
                </div>
            </div>

            <div class="my-5 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-bold text-gray-600 mb-3 border-b pb-1">ข้อมูลเดิม (Current)</h4>
                    <div class="space-y-2 text-sm text-gray-700">
                        <p><span class="font-bold">คันที่:</span> <span id="md_carNo" class="text-indigo-600 font-bold"></span></p>
                        <p><span class="font-bold">โหลดงาน:</span> <span id="md_loadDate"></span></p>
                        <p><span class="font-bold">รอบโหลด:</span> <span id="md_roundTime"></span></p>
                        <div class="mt-2">
                            <span class="font-bold">สาขา:</span>
                            <ul id="md_branches" class="list-disc pl-5 text-xs text-gray-600 mt-1"></ul>
                        </div>
                        <hr class="my-2 border-gray-200">
                        <p><span class="font-bold">ทะเบียน:</span> <span id="md_oldPlate"></span></p>
                        <p><span class="font-bold">คนขับ:</span> <span id="md_oldDriver"></span></p>
                        <p><span class="font-bold">เลขบัตร:</span> <span id="md_oldID" class="text-gray-500">-</span></p>
                        <p><span class="font-bold">เบอร์โทร:</span> <span id="md_oldPhone" class="text-gray-500">-</span></p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border-2 border-orange-100 shadow-inner">
                    <h4 class="font-bold text-orange-600 mb-3 border-b pb-1">ข้อมูลใหม่ (New)</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">เลือกคนขับใหม่</label>
                            <select id="md_newDriverSelect" onchange="updateNewDriverInfo()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 p-2 border">
                                <option value="">-- เลือก --</option>
                                {% for driver in drivers %}
                                <option value="{{ driver.Name }}">{{ driver.Name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-3 bg-orange-50 p-3 rounded text-sm">
                            <div>
                                <span class="block text-xs text-gray-500">ทะเบียนใหม่</span>
                                <span id="md_newPlate" class="font-bold text-gray-800">-</span>
                            </div>
                            <div>
                                <span class="block text-xs text-gray-500">เบอร์โทร</span>
                                <span id="md_newPhone" class="font-bold text-gray-800">-</span>
                            </div>
                            <div class="col-span-2">
                                <span class="block text-xs text-gray-500">เลขบัตรประชาชน</span>
                                <span id="md_newID" class="font-bold text-gray-800">-</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">เนื่องจากสาเหตุ</label>
                            <textarea id="md_reason" rows="2" class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 p-2 border" placeholder="เช่น รถเสีย, คนขับลาป่วย..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end pt-2 gap-3 border-t mt-4">
                <button onclick="closeChangeDriverModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">ปิด</button>
                
                <button id="btn-save-driver" onclick="saveChangeDriverToDB()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow flex items-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> บันทึกลงระบบ
                </button>

                <button onclick="copyChangeDriverText()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow flex items-center gap-2">
                    <i class="fa-regular fa-copy"></i> คัดลอกข้อความ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        const savedTab = localStorage.getItem('activeTab') || 'tab-monitor';
        if(tabParam) switchTab('tab-' + tabParam); else switchTab(savedTab);
        
        const timeEl = document.getElementById('report-time');
        if (timeEl) timeEl.innerText = new Date().toLocaleString('th-TH');
    });

    function autoSetLoadDate() {
        const poInput = document.getElementById('po_date_input');
        const loadInput = document.getElementById('load_date_input');
        if (poInput.value) {
            const poDate = new Date(poInput.value);
            poDate.setDate(poDate.getDate() - 1);
            const year = poDate.getFullYear();
            const month = String(poDate.getMonth() + 1).padStart(2, '0');
            const day = String(poDate.getDate()).padStart(2, '0');
            loadInput.value = `${year}-${month}-${day}`;
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow', 'hover:bg-indigo-700');
            btn.classList.add('bg-white', 'text-gray-600', 'hover:bg-gray-100');
        });

        document.getElementById(tabId).classList.remove('hidden');
        let btn = document.getElementById(tabId.replace('tab-', 'btn-'));
        if (btn) {
            btn.classList.remove('bg-white', 'text-gray-600', 'hover:bg-gray-100');
            btn.classList.add('bg-indigo-600', 'text-white', 'shadow', 'hover:bg-indigo-700');
        }
        localStorage.setItem('activeTab', tabId);
    }

    function updatePlate() {
        const select = document.getElementById('driver_select');
        const selectedOption = select.options[select.selectedIndex];
        const plate = selectedOption.getAttribute('data-plate');
        const plateInput = document.getElementById('plate_input');
        if (plateInput) plateInput.value = plate || "";
    }

    function addBranchField() {
        const container = document.getElementById('branch-container');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `<span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">${count}</span><input type="text" name="branches" placeholder="ระบุชื่อสาขาที่ ${count}" required class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2 transition"><i class="fa-solid fa-trash"></i></button>`;
        container.appendChild(div);
    }

    function copyCustomerLink() {
        let url = window.location.origin + "/tracking";
        copyToClipboard(url, "ลิงค์สำหรับลูกค้า");
    }

    function getFilterDate() {
        let el = document.getElementById('report_date_filter');
        if (!el) el = document.querySelector('input[name="date_filter"]');
        return el ? el.value : '';
    }

    function triggerExport() {
        const selectedDate = getFilterDate();
        let url = '/export_excel'; 
        if (selectedDate) url += `?date_filter=${selectedDate}`;
        window.location.href = url;
    }

    function triggerCustomerPDF() {
        const selectedDate = getFilterDate();
        let url = '/export_pdf'; 
        if (selectedDate) url += `?date_filter=${selectedDate}`;
        window.location.href = url;
    }
    
    function triggerCompactPDF() {
        const selectedDate = getFilterDate();
        let url = '/export_pdf_summary'; 
        if (selectedDate) url += `?date_filter=${selectedDate}`;
        window.location.href = url;
    }

    async function copyToClipboard(text, successMessage) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("✅ คัดลอก" + successMessage + "เรียบร้อยแล้ว!");
            return;
        } catch (err) {
            console.error('Fallback copy failed', err);
            document.body.removeChild(textArea);
        }

        if (navigator.clipboard && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(text);
                alert("✅ คัดลอก" + successMessage + "เรียบร้อยแล้ว!");
            } catch (err) {
                console.error('Async Copy failed', err);
                alert("❌ ไม่สามารถคัดลอกได้");
            }
        }
    }

    function shareLine(shiftType) {
        const dayData = {{ line_data_day | tojson | safe }};
        const nightData = {{ line_data_night | tojson | safe }};
        const dataList = (shiftType === 'day') ? dayData : nightData;
        const shiftName = (shiftType === 'day') ? 'รอบโหลดกลางวัน' : 'รอบโหลดกลางคืน';
        const shiftEmoji = (shiftType === 'day') ? '☀️' : '🌙';
        const poDateVal = getFilterDate(); 
        if (!poDateVal) { alert("กรุณาเลือกวันที่ก่อนแชร์"); return; }
        const [py, pm, pd] = poDateVal.split('-').map(Number);
        const yearThaiShort = (py + 543).toString().slice(2);
        const poDateThai = `${pd.toString().padStart(2,'0')}.${pm.toString().padStart(2,'0')}.${yearThaiShort}`; 

        if (!dataList || dataList.length === 0) { alert(`⚠️ ไม่พบข้อมูลงานสำหรับ ${shiftName}`); return; }

        let msg = `📄 LMT PO ${poDateThai} (${shiftEmoji} ${shiftName})\n`;
        if (dataList.length > 0) msg += `📅 โหลดวันที่: ${dataList[0].load_date}\n\n`;

        let groupedByRound = {};
        dataList.forEach(item => {
            let r = item.round || "ไม่ระบุเวลา";
            if (!groupedByRound[r]) groupedByRound[r] = [];
            groupedByRound[r].push(item);
        });

        for (const [roundTime, cars] of Object.entries(groupedByRound)) {
            msg += `🕒 รอบโหลด ${roundTime} น.\n`;
            cars.forEach(car => {
                msg += `🚛 คันที่ ${car.car_no} ${car.plate}\n`; 
                msg += `👨‍✈️ ${car.driver}\n`; 
                car.branches.forEach(branch => { msg += `📍 ${branch}\n`; });
                msg += `\n`; 
            });
        }
        copyToClipboard(msg, "ตารางงาน");
    }
	
    function copyUpdateText(shiftType) {
        const dayData = {{ line_data_day | tojson | safe }};
        const nightData = {{ line_data_night | tojson | safe }};
        const dataList = (shiftType === 'day') ? dayData : nightData;
        const shiftLabel = (shiftType === 'day') ? 'รอบบ่าย' : 'รอบดึก';
        const poDateVal = getFilterDate(); 
        if (!poDateVal) { alert("กรุณาเลือกวันที่ก่อน"); return; }
        const [py, pm, pd] = poDateVal.split('-').map(Number);
        const poDateFormatted = `${pd.toString().padStart(2,'0')}.${pm.toString().padStart(2,'0')}.${py + 543}`; 

        if (!dataList || dataList.length === 0) { alert(`⚠️ ไม่พบข้อมูลสำหรับ ${shiftLabel}`); return; }

        let msg = `อัพเดท รอบโหลด (${shiftLabel})\n`;
        msg += `🚛 LMT PO.${poDateFormatted}\n\n`;

        let groupedByRound = {};
        dataList.forEach(item => {
            let r = item.round || "ไม่ระบุ";
            r = r.replace(':', '.'); 
            if (!groupedByRound[r]) groupedByRound[r] = [];
            groupedByRound[r].push(item);
        });

        for (const [roundTime, cars] of Object.entries(groupedByRound)) {
            msg += `🕒 รอบโหลด : ${roundTime} น.\n`; 
            cars.forEach(car => {
                let statusShow = car.latest_status.replace(')', ' น.)');
                msg += `คันที่ ${car.car_no} ${car.plate} = ${statusShow}\n`;
            });
            msg += `\n`; 
        }
        copyToClipboard(msg, "ข้อความอัพเดทสถานะ");
    }

    let currentModalData = {};

    function openChangeDriverModal(buttonEl) {
        const data = JSON.parse(buttonEl.dataset.info);
        currentModalData = data;
        
        document.getElementById('md_carNo').innerText = '#' + data.carNo;
        document.getElementById('md_loadDate').innerText = data.loadDate;
        document.getElementById('md_roundTime').innerText = data.roundTime;
        document.getElementById('md_oldPlate').innerText = data.oldPlate;
        document.getElementById('md_oldDriver').innerText = data.oldDriver;
        
        const oldDriverInfo = driverData[data.oldDriver] || {};
        document.getElementById('md_oldID').innerText = oldDriverInfo.id_card || '-';
        document.getElementById('md_oldPhone').innerText = oldDriverInfo.phone || '-';

        const list = document.getElementById('md_branches');
        list.innerHTML = '';
        data.branches.forEach(b => {
            const li = document.createElement('li');
            li.innerText = b;
            list.appendChild(li);
        });

        document.getElementById('md_newDriverSelect').value = "";
        document.getElementById('md_newPlate').innerText = "-";
        document.getElementById('md_newID').innerText = "-";
        document.getElementById('md_newPhone').innerText = "-";
        document.getElementById('md_reason').value = "";

        const modal = document.getElementById('changeDriverModal');
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    }

    function closeChangeDriverModal() {
        const modal = document.getElementById('changeDriverModal');
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.body.classList.remove('modal-active');
    }

    function updateNewDriverInfo() {
        const name = document.getElementById('md_newDriverSelect').value;
        if (name && driverData[name]) {
            const info = driverData[name];
            document.getElementById('md_newPlate').innerText = info.plate;
            document.getElementById('md_newID').innerText = info.id_card;
            document.getElementById('md_newPhone').innerText = info.phone;
        } else {
            document.getElementById('md_newPlate').innerText = "-";
            document.getElementById('md_newID').innerText = "-";
            document.getElementById('md_newPhone').innerText = "-";
        }
    }

    function copyChangeDriverText() {
        const newDriverName = document.getElementById('md_newDriverSelect').value;
        if (!newDriverName) { alert('กรุณาเลือกคนขับใหม่'); return; }

        const reason = document.getElementById('md_reason').value;
        const oldInfo = driverData[currentModalData.oldDriver] || {};
        const newInfo = driverData[newDriverName] || {};

        let branchText = "";
        currentModalData.branches.forEach(b => {
            branchText += `📍 ${b}\n`;
        });

        const msg = `เรียน ผู้เกี่ยวข้อง
📢 แจ้งแก้ไขเปลี่ยนทะเบียนรถ/คนขับรับงาน

🚛 คันที่ : ${currentModalData.carNo}
📅 PO Date : ${currentModalData.poDate}
🗓️ โหลดงาน : ${currentModalData.loadDate}
⏰ รอบโหลด : ${currentModalData.roundTime}
${branchText}
➖➖➖➖➖➖➖➖➖➖
🔴 แผนเดิม
ทะเบียน : ${currentModalData.oldPlate}
คนขับ : ${currentModalData.oldDriver}
🆔 : ${oldInfo.id_card || '-'}
📞 : ${oldInfo.phone || '-'}

🟢 เปลี่ยนเป็น
ทะเบียน : ${newInfo.plate || '-'}
คนขับ : ${newDriverName}
🆔 : ${newInfo.id_card || '-'}
📞 : ${newInfo.phone || '-'}

💬 เนื่องจาก : ${reason}

ขอบคุณครับ 🙏`;

        copyToClipboard(msg, "ข้อความแจ้งเปลี่ยนงาน");
    }

    function saveChangeDriverToDB() {
        const newDriverName = document.getElementById('md_newDriverSelect').value;
        const newPlate = document.getElementById('md_newPlate').innerText;

        if (!newDriverName) { 
            alert('❌ กรุณาเลือกคนขับใหม่ก่อนบันทึก'); 
            return; 
        }

        if (!confirm(`ยืนยันการเปลี่ยนคนขับเป็น "${newDriverName}" \nสำหรับรถคันที่ #${currentModalData.carNo} ทุกรายการ?`)) {
            return;
        }

        const btn = document.getElementById('btn-save-driver');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังบันทึก...';
        btn.disabled = true;
        btn.classList.add('opacity-50');

        const targetPO = document.querySelector('input[name="date_filter"]').value; 

        const payload = {
            po_date: targetPO, 
            round_time: currentModalData.roundTime,
            car_no: currentModalData.carNo,
            new_driver: newDriverName,
            new_plate: newPlate
        };

        fetch('/update_driver', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(`✅ บันทึกเรียบร้อย! อัพเดทข้อมูลไป ${data.count} แถว`);
                location.reload(); 
            } else {
                alert('❌ เกิดข้อผิดพลาด: ' + data.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('❌ เชื่อมต่อเซิร์ฟเวอร์ไม่ได้');
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        });
    }
</script>

{% endblock %}