{% extends "layout.html" %}
{% block content %}

{% macro render_step_button(row_id, driver_name, step_id, label, color_class, icon, val) %}
<form action="/update_status" method="POST" class="w-full relative" id="form-{{ row_id }}-{{ step_id }}">
    <input type="hidden" name="row_id" value="{{ row_id }}">
    <input type="hidden" name="driver_name" value="{{ driver_name }}">
    <input type="hidden" name="step" value="{{ step_id }}">
    <input type="hidden" name="mode" id="mode-{{ row_id }}-{{ step_id }}" value="update">
    <input type="hidden" name="lat" id="lat-{{ row_id }}-{{ step_id }}">
    <input type="hidden" name="long" id="long-{{ row_id }}-{{ step_id }}">
    
    <button type="button" onclick="getLocationAndSubmit('{{ row_id }}', '{{ step_id }}')"
        class="w-full py-2.5 rounded-lg shadow-sm active:scale-95 transition-all flex flex-col md:flex-row items-center justify-center gap-1 relative overflow-hidden group
        {% if val %} 
            bg-gray-50 border border-gray-100 text-gray-400 cursor-default
        {% else %} 
            {% if 'from-' in color_class %} bg-gradient-to-br {{ color_class }} text-white {% else %} {{ color_class }} text-white {% endif %} hover:shadow-md
        {% endif %}"
        {% if val %} disabled {% endif %}>
        
        {% if val %}
            <div class="absolute top-0.5 right-1 text-green-500"><i class="fa-solid fa-circle-check text-[10px]"></i></div>
            <span class="text-xs font-bold text-gray-600 font-mono">{{ val }}</span>
            <span class="text-[8px] text-gray-400">{{ label }}</span>
        {% else %}
            <i class="fa-solid {{ icon }} text-lg mb-0.5 md:mb-0 md:mr-1"></i>
            <span class="text-[10px] md:text-xs font-medium leading-tight">{{ label }}</span>
        {% endif %}
    </button>

    {% if val %}
    <div onclick="confirmReset('{{ row_id }}', '{{ step_id }}', event)" 
            class="absolute top-0 left-0 bg-red-50 hover:bg-red-100 text-red-400 hover:text-red-600 p-1 rounded-br-lg cursor-pointer z-10 transition-colors shadow-sm border-r border-b border-gray-100"
            title="ยกเลิก">
        <i class="fa-solid fa-rotate-left text-[10px]"></i>
    </div>
    {% endif %}
</form>
{% endmacro %}

{% macro render_trip_card(trip_group, driver_name, is_active) %}
    {% set first_job = trip_group[0] %}
    {% set row_id = first_job.row_id %}
    
    <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative ring-1 ring-indigo-50 mb-6">
        
        <div class="{% if is_active %} bg-gradient-to-r from-slate-800 to-slate-700 {% else %} bg-gray-600 {% endif %} px-4 py-3 flex justify-between items-start text-white">
            <div class="flex items-center gap-3">
                <div class="{% if is_active %} bg-yellow-400 text-slate-900 border-slate-600 {% else %} bg-gray-400 text-white border-gray-500 {% endif %} w-10 h-10 rounded-xl flex items-center justify-center font-extrabold text-xl shadow-lg border-2">
                    {{ first_job.Car_No }}
                </div>
                <div>
                    <div class="text-[10px] text-slate-300 font-medium uppercase tracking-wide opacity-80">ทะเบียนรถ</div>
                    <div class="text-base font-bold font-mono tracking-wider">{{ first_job.Plate }}</div>
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="text-[10px] text-slate-300 font-medium uppercase opacity-80">เวลาโหลด</div>
                <div class="text-xl font-bold {% if is_active %} text-yellow-400 {% else %} text-gray-200 {% endif %} font-mono leading-none">{{ first_job.Round }}</div>
                
                {% if first_job.get('Weight') %}
				<div class="mt-1.5 inline-flex items-center gap-1 bg-white/10 px-2 py-0.5 rounded text-[10px] text-white/90 font-medium border border-white/10">
				<i class="fa-solid fa-weight-hanging text-[9px]"></i> {{ first_job.Weight | comma_format }}
				</div>
				{% endif %}
            </div>
        </div>

        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center gap-2 mb-3 text-xs font-bold text-gray-500 uppercase tracking-wider">
                <i class="fa-solid fa-industry"></i> โรงงาน
            </div>
            <div class="grid grid-cols-3 gap-2">
                {% set factory_buttons = [
                    ('1', 'เข้าโรงงาน', 'from-blue-500 to-blue-600', 'fa-door-open', first_job.T1_Enter),
                    ('2', 'เริ่มโหลด', 'from-indigo-500 to-indigo-600', 'fa-dolly', first_job.T2_StartLoad),
                    ('3', 'โหลดเสร็จ', 'from-cyan-500 to-cyan-600', 'fa-clipboard-check', first_job.T3_EndLoad),
                    ('4', 'ยื่นเอกสาร', 'from-amber-500 to-amber-600', 'fa-file-export', first_job.T4_SubmitDoc),
                    ('5', 'รับเอกสาร', 'from-orange-500 to-orange-600', 'fa-file-invoice', first_job.T5_RecvDoc),
                    ('6', 'ออกโรงงาน', 'from-purple-500 to-purple-600', 'fa-truck-fast', first_job.T6_Exit)
                ] %}
                {% for step_id, label, grad, icon, val in factory_buttons %}
                    {{ render_step_button(row_id, driver_name, step_id, label, grad, icon, val) }}
                {% endfor %}
            </div>
        </div>

        <div class="p-4 bg-gray-50/50 space-y-5">
            <div class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wider">
                <i class="fa-solid fa-map-location-dot"></i> จุดส่งสินค้า ({{ trip_group|length }} สาขา)
            </div>
            
            {% for job in trip_group %}
                <div class="relative pl-3 border-l-2 {% if job.Status == 'Done' %} border-green-400 {% else %} border-indigo-200 {% endif %} pb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm font-bold leading-tight {% if '(ด่วน)' in job.Branch_Name %} text-red-600 animate-pulse {% else %} text-gray-800 {% endif %}">
                            {{ loop.index }}. {{ job.Branch_Name }}
                        </div>
                        
                        {% if job.Status == 'Done' %}
                            <div class="text-green-500"><i class="fa-solid fa-circle-check"></i></div>
                        {% endif %}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        {% set branch_buttons = [
                            ('7', 'ถึงสาขา', 'bg-emerald-500', 'fa-location-dot', job.T7_ArriveBranch),
                            ('8', 'จบงาน', 'bg-rose-600', 'fa-flag-checkered', job.T8_EndJob)
                        ] %}
                        {% for step_id, label, color, icon, val in branch_buttons %}
                            {{ render_step_button(job.row_id, driver_name, step_id, label, color, icon, val) }}
                        {% endfor %}
                    </div>

                    <!-- [ส่วนที่แก้ไข] พื้นที่กรอกข้อมูล PO (อยู่ใต้ปุ่มกดเวลา) -->
                    {% if job.parsed_po_details %}
                    <div class="mt-3 bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                        <div class="bg-gray-50 px-3 py-1.5 border-b border-gray-200 flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-list text-gray-400 text-xs"></i>
                            <span class="text-[10px] font-bold text-gray-500 uppercase">บันทึกข้อมูลสินค้า</span>
                        </div>
                        
                        <div class="p-3 space-y-4">
                            {% for po in job.parsed_po_details %}
                            <div class="relative pl-3 border-l-2 border-indigo-100">
                                <!-- หัวข้อ PO -->
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-indigo-50 text-indigo-600 text-[9px] font-bold px-1.5 py-0.5 rounded border border-indigo-100">
                                        PO
                                    </span>
                                    <span class="text-xs font-bold text-gray-600 font-mono">{{ po.name }}</span>
                                </div>

                                <!-- 1. ช่องกรอกเลข Doc (แก้ไขใหม่: บังคับ 6 หลัก มี 755 นำหน้า) -->
                                <div class="flex items-center gap-2 mb-2" id="box-doc-{{ job.row_id }}-{{ loop.index }}">
                                    <div class="w-6 text-center text-gray-300 text-xs"><i class="fa-solid fa-file-invoice"></i></div>
                                    
                                    {% if po.doc %}
                                        <!-- กรณีมีข้อมูลแล้ว (แสดงผล + ปุ่มแก้) -->
                                        <div class="flex-1 text-xs font-mono font-bold text-green-700 bg-green-50/50 px-2 py-1.5 rounded border border-green-200 border-dashed">
                                            {{ po.doc }}
                                        </div>
                                        <button onclick="toggleEdit('doc', '{{ job.row_id }}', '{{ loop.index }}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-indigo-600 bg-white rounded-full border border-gray-100 shadow-sm transition">
                                            <i class="fa-solid fa-pen-to-square text-xs"></i>
                                        </button>
                                    {% else %}
                                        <!-- กรณีโหมดกรอกข้อมูล -->
                                        <div class="flex-1 flex items-center shadow-sm">
                                            <span class="bg-gray-100 text-gray-500 border border-r-0 border-gray-300 rounded-l-lg px-2 py-1.5 text-xs font-mono font-bold">755</span>
                                            <input type="text" inputmode="numeric" maxlength="6" id="input-doc-{{ job.row_id }}-{{ loop.index }}" 
                                                placeholder="xxxxxx" 
                                                class="w-full text-xs border-gray-300 rounded-r-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono px-2 py-1.5 border border-l-0"
                                                oninput="validateInputLive(this)">
                                        </div>
                                        <button onclick="saveDetail('doc', '{{ job.row_id }}', '{{ po.name }}', '{{ loop.index }}')" 
                                            class="bg-indigo-600 text-white w-7 h-7 rounded-lg shadow hover:bg-indigo-700 flex items-center justify-center transition active:scale-95 ml-2 flex-shrink-0">
                                            <i class="fa-solid fa-save text-xs"></i>
                                        </button>
                                    {% endif %}
                                </div>
                                
                                <!-- ส่วนซ่อนสำหรับ Edit Mode (Doc) -->
                                {% if po.doc %}
                                <div id="edit-doc-{{ job.row_id }}-{{ loop.index }}" class="hidden flex items-center gap-2 mb-2 animate-fade-in-down">
                                    <div class="w-6 text-center text-gray-300 text-xs"><i class="fa-solid fa-file-invoice"></i></div>
                                    
                                    <div class="flex-1 flex items-center shadow-sm">
                                        <span class="bg-gray-100 text-gray-500 border border-r-0 border-gray-300 rounded-l-lg px-2 py-1.5 text-xs font-mono font-bold">755</span>
                                        <!-- ดึงค่ามาแสดงเฉพาะ 6 หลักหลัง (ตัด 755 ออก) เพื่อให้แก้เฉพาะเลข -->
                                        {% set short_doc = po.doc|replace('755', '', 1) if po.doc.startswith('755') else po.doc %}
                                        <input type="text" inputmode="numeric" maxlength="6" id="input-edit-doc-{{ job.row_id }}-{{ loop.index }}" value="{{ short_doc }}"
                                            class="w-full text-xs border-indigo-300 rounded-r-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono px-2 py-1.5 border border-l-0 bg-indigo-50/10"
                                            oninput="validateInputLive(this)">
                                    </div>

                                    <button onclick="saveDetail('doc', '{{ job.row_id }}', '{{ po.name }}', '{{ loop.index }}', true)" 
                                        class="bg-green-600 text-white w-7 h-7 rounded-lg shadow hover:bg-green-700 flex items-center justify-center transition active:scale-95 flex-shrink-0">
                                        <i class="fa-solid fa-check text-xs"></i>
                                    </button>
                                    <button onclick="toggleEdit('doc', '{{ job.row_id }}', '{{ loop.index }}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition flex-shrink-0">
                                        <i class="fa-solid fa-xmark text-xs"></i>
                                    </button>
                                </div>
                                {% endif %}

                                <!-- 2. ช่องกรอกน้ำหนัก -->
                                <div class="flex items-center gap-2" id="box-weight-{{ job.row_id }}-{{ loop.index }}">
                                    <div class="w-6 text-center text-gray-300 text-xs"><i class="fa-solid fa-weight-hanging"></i></div>
                                    
                                    {% if po.weight %}
                                        <!-- กรณีมีข้อมูลแล้ว -->
                                        <div class="flex-1 text-xs font-mono font-bold text-blue-700 bg-blue-50/50 px-2 py-1.5 rounded border border-blue-200 border-dashed">
                                            {{ po.weight }} กก.
                                        </div>
                                        <button onclick="toggleEdit('weight', '{{ job.row_id }}', '{{ loop.index }}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-indigo-600 bg-white rounded-full border border-gray-100 shadow-sm transition">
                                            <i class="fa-solid fa-pen-to-square text-xs"></i>
                                        </button>
                                    {% else %}
                                        <!-- กรณีโหมดกรอกข้อมูล -->
                                        <input type="number" step="0.01" id="input-weight-{{ job.row_id }}-{{ loop.index }}" 
                                            placeholder="0.00 กก." 
                                            class="flex-1 text-xs border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono px-2 py-1.5 border shadow-sm">
                                        <button onclick="saveDetail('weight', '{{ job.row_id }}', '{{ po.name }}', '{{ loop.index }}')" 
                                            class="bg-indigo-600 text-white w-7 h-7 rounded-lg shadow hover:bg-indigo-700 flex items-center justify-center transition active:scale-95 ml-2">
                                            <i class="fa-solid fa-save text-xs"></i>
                                        </button>
                                    {% endif %}
                                </div>
                                
                                <!-- ส่วนซ่อนสำหรับ Edit Mode (Weight) -->
                                {% if po.weight %}
                                <div id="edit-weight-{{ job.row_id }}-{{ loop.index }}" class="hidden flex items-center gap-2 animate-fade-in-down">
                                    <div class="w-6 text-center text-gray-300 text-xs"><i class="fa-solid fa-weight-hanging"></i></div>
                                    <input type="number" step="0.01" id="input-edit-weight-{{ job.row_id }}-{{ loop.index }}" value="{{ po.weight }}"
                                        class="flex-1 text-xs border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono px-2 py-1.5 border shadow-sm bg-indigo-50/10">
                                    <button onclick="saveDetail('weight', '{{ job.row_id }}', '{{ po.name }}', '{{ loop.index }}', true)" 
                                        class="bg-green-600 text-white w-7 h-7 rounded-lg shadow hover:bg-green-700 flex items-center justify-center transition active:scale-95">
                                        <i class="fa-solid fa-check text-xs"></i>
                                    </button>
                                    <button onclick="toggleEdit('weight', '{{ job.row_id }}', '{{ loop.index }}')" class="w-7 h-7 flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition">
                                        <i class="fa-solid fa-xmark text-xs"></i>
                                    </button>
                                </div>
                                {% endif %}

                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <!-- จบส่วนที่เพิ่มใหม่ -->

                </div>
            {% endfor %}
        </div>
    </div>
{% endmacro %}

<div class="sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 shadow-sm">
    <div class="max-w-2xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-100 p-2 rounded-full text-indigo-600">
                <i class="fa-solid fa-user-astronaut text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg font-bold text-gray-800 leading-tight">งานของคุณ</h2>
                <p class="text-xs text-gray-500 font-medium">{{ name }}</p>
            </div>
        </div>
        <a href="/driver" class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition flex items-center gap-1">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> เปลี่ยนชื่อ
        </a>
    </div>
</div>

<div class="max-w-2xl mx-auto px-4 pb-20 pt-4">

{% if jobs|length == 0 %}
    <div class="flex flex-col items-center justify-center py-16 text-center">
        <div class="bg-green-50 p-6 rounded-full mb-4 animate-bounce">
            <i class="fa-solid fa-mug-hot text-5xl text-green-500"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800">ไม่มีงานค้าง</h3>
        <p class="text-gray-400 mt-1 text-sm">พักผ่อนได้เต็มที่เลยครับ!</p>
    </div>
{% else %}

    {% set trips = {} %}
    {% set trip_keys = [] %}
    
    {% for job in jobs %}
        {# สร้าง Key สำหรับ Grouping #}
        {% set key = job.PO_Date ~ '|' ~ job.Round ~ '|' ~ job.Car_No %}
        
        {% if key not in trips %}
            {% set _ = trips.update({key: []}) %}
            {% set _ = trip_keys.append(key) %}
        {% endif %}
        {% set _ = trips[key].append(job) %}
    {% endfor %}

    {% set active_trips = [] %}
    {% set history_trips = [] %}
    
    {% for key in trip_keys %}
        {% set trip_group = trips[key] %}
        
        {# ตรวจสอบว่างานใน Group นี้เสร็จหมดหรือยัง (ต้องเสร็จทุกสาขา) #}
        {% set ns = namespace(is_done=true) %}
        {% for j in trip_group %}
            {% if j.Status != 'Done' %}
                {% set ns.is_done = false %}
            {% endif %}
        {% endfor %}
        
        {% if ns.is_done %}
            {% set _ = history_trips.append(trip_group) %}
        {% else %}
            {% set _ = active_trips.append(trip_group) %}
        {% endif %}
    {% endfor %}

    {% if active_trips|length > 0 %}
        {% set current_group = active_trips[0] %}
        {% set current_job_head = current_group[0] %}
        
        {% if active_trips|length > 1 %}
            <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 mb-4 flex items-center justify-between shadow-sm animate-pulse">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div>
                        <div class="text-xs text-blue-500 font-bold uppercase">คิวงานถัดไป</div>
                        <div class="text-sm font-bold text-blue-800">มีงานรออีก {{ active_trips|length - 1 }} เที่ยว</div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% set ns_trip_status = namespace(all_done=true) %}
        {% for job in current_group %}
            {% if job.Status != 'Done' %}
                {% set ns_trip_status.all_done = false %}
            {% endif %}
        {% endfor %}

        {% if ns_trip_status.all_done %}
            <div class="mb-4 bg-green-50 border border-green-200 rounded-2xl p-4 shadow-sm flex items-center gap-4">
                <div class="bg-white p-3 rounded-full shadow-sm text-green-500">
                    <i class="fa-solid fa-circle-check text-3xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-green-800">งานเสร็จแล้ว</h3>
                    <p class="text-sm text-green-600">ส่งครบเรียบร้อย ({{ current_job_head.PO_Date }})</p>
                </div>
            </div>
        {% else %}
            <div class="mb-4 rounded-2xl border p-4 shadow-sm {{ current_job_head.ui_class.bg }}">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-3 rounded-2xl shadow-sm text-2xl {{ current_job_head.ui_class.text }} flex items-center justify-center w-14 h-14 border border-gray-100 flex-shrink-0">
                        <i class="fa-solid {{ current_job_head.ui_class.icon }}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg font-bold text-gray-800 leading-tight truncate">{{ current_job_head.smart_title }}</h3>
                        <div class="text-sm text-gray-600 font-medium mt-1 truncate">{{ current_job_head.smart_detail }}</div>
                        <div class="text-[11px] text-gray-400 font-light mt-0.5 truncate"><i class="fa-solid fa-file-invoice"></i> {{ current_job_head.po_label }}</div>
                    </div>
                </div>
            </div>
        {% endif %}

        {{ render_trip_card(current_group, name, True) }}

    {% else %}
        <div class="flex flex-col items-center justify-center py-10 text-center">
            <div class="bg-green-50 p-6 rounded-full mb-4 animate-bounce">
                <i class="fa-solid fa-mug-hot text-5xl text-green-500"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">ไม่มีงานค้าง</h3>
            <p class="text-gray-400 mt-1 text-sm">คุณส่งงานครบทั้งหมดแล้วครับ</p>
        </div>
    {% endif %}


    {% if history_trips|length > 0 %}
        <div class="mt-8 pt-6 border-t border-gray-100">
            <button onclick="toggleHistory()" class="w-full flex items-center justify-between bg-gray-50 hover:bg-gray-100 p-3 rounded-xl transition text-gray-500 border border-gray-200">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span class="text-sm font-bold">ประวัติงานที่ส่งแล้ว (วันนี้)</span>
                    <span class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full">{{ history_trips|length }}</span>
                </div>
                <i id="history-arrow" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
            </button>

            <div id="history-container" class="hidden mt-4 space-y-6">
                {% for group in history_trips %}
                    <div class="relative opacity-90 hover:opacity-100 transition">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <span class="text-xs font-bold text-green-600"><i class="fa-solid fa-check-circle"></i> ส่งเรียบร้อย</span>
                            <span class="text-[10px] text-gray-400">#{{ group[0].Car_No }} | {{ group[0].Round }} น.</span>
                        </div>
                        {{ render_trip_card(group, name, False) }}
                    </div>
                {% endfor %}
                <div class="text-center text-[10px] text-gray-400 pt-2">
                    * สามารถกดปุ่ม <i class="fa-solid fa-rotate-left text-red-400"></i> เพื่อแก้ไขงานย้อนหลังได้
                </div>
            </div>
        </div>
    {% endif %}

{% endif %}

</div>

<script>
    // ฟังก์ชันเปิด/ปิด ประวัติงาน
    function toggleHistory() {
        const container = document.getElementById('history-container');
        const arrow = document.getElementById('history-arrow');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        } else {
            container.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    function getLocationAndSubmit(rowId, stepId) {
        const btn = document.querySelector(`#form-${rowId}-${stepId} button`);
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-lg"></i>`;
        btn.disabled = true;
        btn.classList.add('opacity-70');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById(`lat-${rowId}-${stepId}`).value = position.coords.latitude;
                    document.getElementById(`long-${rowId}-${stepId}`).value = position.coords.longitude;
                    document.getElementById(`form-${rowId}-${stepId}`).submit();
                },
                function(error) {
                    console.warn("GPS Error:", error);
                    document.getElementById(`form-${rowId}-${stepId}`).submit();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            document.getElementById(`form-${rowId}-${stepId}`).submit();
        }
    }

    function confirmReset(rowId, stepId, event) {
        event.preventDefault();
        event.stopPropagation();

        if (confirm("⚠️ ต้องการลบเวลาและบันทึกใหม่ใช่หรือไม่?")) {
            document.getElementById(`mode-${rowId}-${stepId}`).value = 'cancel';
            
            const btn = document.querySelector(`#form-${rowId}-${stepId} button`);
            // แสดงสถานะกำลังลบ
            btn.innerHTML = `<i class="fa-solid fa-trash-can fa-shake text-red-500"></i>`;
            
            document.getElementById(`form-${rowId}-${stepId}`).submit();
        }
    }

    // --- [เพิ่มใหม่] ฟังก์ชันสำหรับจัดการ PO Input (AJAX) ---
    
    function validateInputLive(input) {
        // อนุญาตเฉพาะตัวเลข
        input.value = input.value.replace(/[^0-9]/g, '');
        
        // เช็คความยาว
        if (input.value.length === 6) {
            input.classList.remove('border-red-500', 'bg-red-50');
            input.classList.add('border-green-500', 'bg-green-50');
        } else {
            input.classList.remove('border-green-500', 'bg-green-50');
            input.classList.remove('border-gray-300'); // Remove default
            input.classList.add('border-red-500', 'bg-red-50'); // Add error style
        }
    }

    function toggleEdit(type, rowId, idx) {
        const box = document.getElementById(`box-${type}-${rowId}-${idx}`);
        const edit = document.getElementById(`edit-${type}-${rowId}-${idx}`);
        
        if (box.classList.contains('hidden')) {
            box.classList.remove('hidden');
            edit.classList.add('hidden');
        } else {
            box.classList.add('hidden');
            edit.classList.remove('hidden');
        }
    }

    function saveDetail(type, rowId, poName, idx, isEdit = false) {
        const inputId = isEdit ? `input-edit-${type}-${rowId}-${idx}` : `input-${type}-${rowId}-${idx}`;
        const input = document.getElementById(inputId);
        let val = input.value.trim();

        // Validation Logic ใหม่
        if (type === 'doc') {
            if (val.length !== 6) {
                alert('⚠️ กรุณากรอกเลขท้าย 6 หลักให้ครบถ้วน (ไม่ต้องพิมพ์ 755)');
                input.focus();
                return;
            }
            // อัตโนมัติเพิ่ม 755
            val = '755' + val;
        }
        
        if (type === 'weight') {
            if (!val || isNaN(val)) {
                alert('⚠️ กรุณากรอกน้ำหนักให้ถูกต้อง');
                input.focus();
                return;
            }
            val = parseFloat(val).toFixed(2);
        }

        const btn = event.currentTarget; 
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;

        fetch('/save_po_detail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                row_id: rowId,
                po_name: poName,
                type: type,
                value: val
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload(); 
            } else {
                alert('เกิดข้อผิดพลาด: ' + data.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert('เชื่อมต่อ Server ไม่ได้');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }
</script>
{% endblock %}