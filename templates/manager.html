{% extends "layout.html" %}
{% block content %}

<style>
    body, h1, h2, h3, h4, h5, h6, p, span, div, table, input, select, button {
        font-family: 'Kanit', sans-serif !important;
    }
    .table-data { font-size: 0.85rem; } 
    .table-header { font-size: 0.75rem; }
</style>

<div class="max-w-7xl mx-auto pb-10">
    
    <div class="grid grid-cols-6 gap-3 mb-6">
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
            <div class="text-gray-500 text-xs font-bold uppercase">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_trips }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-700">
            <div class="text-gray-500 text-xs font-bold uppercase">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="text-2xl font-bold text-green-700">{{ completed_trips }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-gray-400">
            <div class="text-gray-500 text-xs font-bold uppercase">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-gray-800">{{ total_branches }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
            <div class="text-gray-500 text-xs font-bold uppercase">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
            <div class="text-2xl font-bold text-green-600">{{ total_done_jobs }}</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
            <div class="text-gray-500 text-xs font-bold uppercase">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πà‡∏á</div>
            <div class="text-2xl font-bold text-yellow-600">{{ total_running_jobs }}</div>
        </div>
        <div class="bg-indigo-600 p-4 rounded-xl shadow-sm text-white flex flex-col justify-center items-center cursor-pointer hover:bg-indigo-700 active:scale-95 transition group" onclick="copyCustomerLink()">
            <div class="text-xs opacity-80 group-hover:opacity-100"><i class="fa-solid fa-share-nodes"></i> ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <div class="font-bold text-sm mt-1 flex items-center gap-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å <i class="fa-regular fa-copy"></i></div>
        </div>
    </div>

    <div class="flex space-x-2 mb-6 overflow-x-auto no-scrollbar pb-1">
        <button onclick="switchTab('tab-monitor')" id="btn-monitor" class="tab-btn flex-1 py-3 px-4 bg-indigo-600 text-white rounded-lg shadow font-medium transition hover:bg-indigo-700 whitespace-nowrap text-sm"><i class="fa-solid fa-satellite-dish mr-2"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô (Monitor)</button>
        <button onclick="switchTab('tab-create')" id="btn-create" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap text-sm"><i class="fa-solid fa-plus-circle mr-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
        <button onclick="switchTab('tab-report')" id="btn-report" class="tab-btn flex-1 py-3 px-4 bg-white text-gray-600 rounded-lg shadow font-medium transition hover:bg-gray-100 whitespace-nowrap text-sm"><i class="fa-solid fa-table mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Excel Report)</button>
    </div>

    <div id="tab-monitor" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
            
            <div class="p-4 border-b flex flex-wrap justify-between items-center bg-gray-50 gap-3">
                <h3 class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                    <i class="fa-solid fa-list-check text-indigo-600"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô
                </h3>
                
                <form method="GET" action="/manager" class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-gray-300 shadow-sm">
                    <input type="hidden" name="tab" value="monitor">
                    
                    <a href="/manager?tab=monitor&date_filter={{ prev_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-r border-gray-200" title="‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>

                    <span class="text-xs font-bold text-gray-500 pl-1">PO:</span>
                    <input type="date" name="date_filter" value="{{ current_filter_date }}" onchange="this.form.submit()" class="text-sm border-none focus:ring-0 cursor-pointer font-medium text-gray-700 h-8 bg-transparent">
                    
                    <a href="/manager?tab=monitor&date_filter={{ next_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-l border-gray-200" title="‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    
                    <a href="/manager?tab=monitor" class="text-gray-400 hover:text-indigo-600 px-2 border-l border-gray-200" title="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"><i class="fa-solid fa-rotate-right"></i></a>
                </form>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left text-gray-600 table-data">
                    <thead class="text-gray-700 uppercase bg-gray-100 border-b table-header">
                        <tr>
                            <th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-4 py-3">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á (PO / ‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà)</th>
                            <th class="px-4 py-3">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö / ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                            <th class="px-4 py-3 text-center">‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î</th>
                            <th class="px-4 py-3 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                            <th class="px-4 py-3 text-center">‡∏≠‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                            <th class="px-4 py-3 text-center">‡∏à‡∏ö‡∏á‡∏≤‡∏ô (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                            <th class="px-4 py-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% if jobs|length == 0 %}
                            <tr><td colspan="8" class="p-10 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>
                        {% endif %}

                        {% for job in jobs %}
                            {% if loop.first or (loop.previtem.Car_No != job.Car_No or loop.previtem.PO_Date != job.PO_Date or loop.previtem.Round != job.Round) %}
                                
                                {% set current_time_str = now_time %}
                                {% set is_late = (job.Round < current_time_str and job.PO_Date <= today_date) %}
                                
                                {% set trip_key = job.PO_Date ~ "', '" ~ job.Car_No ~ "', '" ~ job.Round %}
                                {% set trip_key_tuple = (job.PO_Date|string, job.Car_No|string, job.Round|string) %}
                                {% set last_end_time = trip_last_end_time.get(trip_key_tuple, "") %}

                                {% if last_end_time %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-sm"><i class="fa-solid fa-flag-checkered"></i> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</span>' %}
                                {% elif job.T6_Exit %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-blue-100 text-blue-700 text-xs font-bold px-3 py-1 rounded-full border border-blue-200"><i class="fa-solid fa-truck-fast"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡πà‡∏á</span>' %}
                                {% elif job.T1_Enter %}
                                    {% set status_badge = '<span class="inline-flex items-center gap-1 bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full border border-indigo-200"><i class="fa-solid fa-warehouse"></i> ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>' %}
                                {% else %}
                                    {% if is_late %}
                                        {% set status_badge = '<span class="inline-flex items-center gap-1 bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full border border-red-200 animate-pulse"><i class="fa-solid fa-circle-exclamation"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤)</span>' %}
                                    {% elif job.PO_Date > today_date %}
                                        {% set status_badge = '<span class="inline-flex items-center gap-1 bg-gray-100 text-gray-500 text-xs font-bold px-3 py-1 rounded-full border border-gray-200"><i class="fa-regular fa-clock"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô</span>' %}
                                    {% else %}
                                        {% set status_badge = '<span class="inline-flex items-center gap-1 bg-gray-200 text-gray-700 text-xs font-bold px-3 py-1 rounded-full border border-gray-300">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</span>' %}
                                    {% endif %}
                                {% endif %}

                                <tr class="hover:bg-indigo-50/30 transition">
                                    <td class="px-4 py-3 text-center">{{ status_badge | safe }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="font-bold text-gray-800">{{ job.PO_Date | thai_date }}</div>
                                        <div class="text-xs text-gray-500">‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà #{{ job.Car_No }}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-900">{{ job.Driver }}</div>
                                        <div class="text-xs text-gray-500 bg-gray-100 inline-block px-1.5 py-0.5 rounded mt-1">{{ job.Plate }}</div>
                                    </td>
                                    <td class="px-4 py-3 text-center font-bold text-indigo-700 text-base">{{ job.Round }}</td>
                                    <td class="px-4 py-3 text-center">
                                        {% if job.T1_Enter %}<span class="text-indigo-600 font-bold">{{ job.T1_Enter }}</span>{% else %}<span class="text-gray-300">-</span>{% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if job.T6_Exit %}<span class="text-blue-600 font-bold">{{ job.T6_Exit }}</span>{% else %}<span class="text-gray-300">-</span>{% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if last_end_time %}
                                            <span class="text-green-600 font-bold">{{ last_end_time }}</span>
                                        {% else %}
                                            <span class="text-gray-300">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center flex justify-center gap-2">
                                        {% if job.L1_Loc %}
                                            <a href="https://www.google.com/maps/search/?api=1&query={{ job.L1_Loc }}" target="_blank" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 transition shadow-sm" title="‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î"><i class="fa-solid fa-location-dot"></i></a>
                                        {% endif %}
                                        <form action="/delete_job" method="POST" onsubmit="return confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ß‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ?');">
                                            <input type="hidden" name="po_date" value="{{ job.PO_Date }}">
                                            <input type="hidden" name="round_time" value="{{ job.Round }}">
                                            <input type="hidden" name="car_no" value="{{ job.Car_No }}">
                                            <button type="submit" class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 hover:text-red-700 transition shadow-sm" title="‡∏•‡∏ö‡∏á‡∏≤‡∏ô"><i class="fa-solid fa-trash-can"></i></button>
                                        </form>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-create" class="tab-content hidden">
        <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-indigo-600"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <form action="/create_job" method="POST" class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (PO Date)</label><input type="date" name="po_date" required class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border bg-gray-50"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î</label><input type="time" name="round_time" required class="w-full rounded-lg border-gray-300 shadow-sm p-2.5 border bg-gray-50"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="number" name="car_no" placeholder="1" required class="w-full rounded-lg border-gray-300 p-2.5 border bg-gray-50"></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
                        <select id="driver_select" name="driver_name" onchange="updatePlate()" required class="w-full rounded-lg border-gray-300 p-2.5 border">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.Name }}" data-plate="{{ driver.Plate_License }}">{{ driver.Name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg flex items-center gap-2 text-sm text-gray-600 border border-gray-200"><i class="fa-solid fa-car-side"></i> ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ: <input type="text" id="plate_input" name="plate_license" readonly class="bg-transparent font-bold text-gray-800 w-full focus:outline-none"></div>
                <hr class="border-gray-100">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                    <div id="branch-container" class="space-y-3">
                        <div class="flex gap-2">
                            <span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">1</span>
                            <input type="text" name="branches" placeholder="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà 1" required class="flex-1 rounded-lg border-gray-300 p-2.5 border">
                        </div>
                    </div>
                    <button type="button" onclick="addBranchField()" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1 transition"><i class="fa-solid fa-circle-plus text-lg"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</button>
                </div>
                <div class="pt-4"><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></div>
            </form>
        </div>
    </div>

    <div id="tab-report" class="tab-content">
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><div class="bg-green-100 p-2 rounded text-green-700"><i class="fa-solid fa-file-csv"></i></div> ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                
                <form method="GET" action="/manager" class="flex flex-wrap gap-2 w-full md:w-auto items-center justify-end">
                    <input type="hidden" name="tab" value="report">
                    
                    <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-gray-300 shadow-sm">
                        <a href="/manager?tab=report&date_filter={{ prev_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-r border-gray-200"><i class="fa-solid fa-chevron-left"></i></a>
                        
                        <span class="text-xs font-bold text-gray-500 pl-1">PO:</span>
                        <input type="date" name="date_filter" id="report_date_filter" value="{{ current_filter_date }}" onchange="this.form.submit()" class="text-sm border-none focus:ring-0 cursor-pointer font-medium text-gray-700 h-8 bg-transparent">
                        
                        <a href="/manager?tab=report&date_filter={{ next_date }}" class="px-2 text-gray-500 hover:text-indigo-600 border-l border-gray-200"><i class="fa-solid fa-chevron-right"></i></a>
                    </div>
			<a href="#" onclick="triggerCustomerPDF()" class="bg-red-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-red-700 transition shadow-md flex items-center gap-2 transform active:scale-95">
				<i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">PDF Export</span>
			</a>
			<a href="#" onclick="triggerCompactPDF()" class="bg-orange-500 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-orange-600 transition shadow-md flex items-center gap-2 transform active:scale-95">
				<i class="fa-solid fa-file-contract"></i> <span class="hidden sm:inline">PDF Summary</span>
			</a>
                    <a href="#" onclick="triggerExport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-bold shadow transition flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Export Excel</a>
					<button onclick="shareLine('day')" class="bg-[#06C755] text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-[#05b34c] transition shadow-md flex items-center gap-1 transform active:scale-95" title="‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô">
        <i class="fa-brands fa-line text-lg"></i> <i class="fa-solid fa-sun text-yellow-300"></i>
    </button>
    <button onclick="shareLine('night')" class="bg-[#06C755] text-white px-3 py-2.5 rounded-lg text-sm font-bold hover:bg-[#05b34c] transition shadow-md flex items-center gap-1 transform active:scale-95" title="‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô">
        <i class="fa-brands fa-line text-lg"></i> <i class="fa-solid fa-moon text-indigo-100"></i>
    </button>
                    <a href="/manager?tab=report" class="bg-white text-gray-500 border border-gray-300 px-3 py-2 rounded-lg hover:bg-gray-100 text-sm shadow-sm"><i class="fa-solid fa-rotate-right"></i></a>
                </form>
            </div>

            <div class="border rounded-lg overflow-hidden overflow-x-auto shadow-inner bg-gray-500">
                <table class="w-full text-center border-collapse whitespace-nowrap table-data">
                    <thead>
                        <tr class="text-white table-header font-bold tracking-wide">
                            <th class="p-3 bg-green-700 border-r border-green-600 sticky left-0 z-10 shadow-lg">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏ñ</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">PO Date</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î</th>
                            <th class="p-3 bg-green-600 border-r border-green-500 min-w-[150px]">‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏™‡∏≤‡∏Ç‡∏≤)</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                            <th class="p-3 bg-green-600 border-r border-green-500">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">1.‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">2.‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">3.‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">4.‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">5.‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                            <th class="p-3 bg-[#c0504d] border-r border-[#a64d4d]">6.‡∏≠‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                            <th class="p-3 bg-[#9bbb59] border-r border-[#8aa64f]">7.‡∏ñ‡∏∂‡∏á‡∏™‡∏≤‡∏Ç‡∏≤</th>
                            <th class="p-3 bg-[#9bbb59]">8.‡∏à‡∏ö‡∏á‡∏≤‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 bg-white">
                        {% if jobs|length == 0 %}
                            <tr><td colspan="14" class="p-10 text-center text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                        {% else %}
                            {% macro report_time_cell(time_val, loc_val, text_class='') %}
                                {% if time_val %}
                                    {% if loc_val %}
                                        <a href="https://maps.google.com/maps?q={{ loc_val }}" target="_blank" 
                                           class="inline-flex items-center justify-center gap-1 hover:bg-gray-100/80 px-1.5 py-0.5 rounded transition group cursor-pointer {{ text_class }}" 
                                           title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                                            {{ time_val }} <i class="fa-solid fa-location-dot text-[10px] opacity-30 group-hover:opacity-100 group-hover:text-blue-600"></i>
                                        </a>
                                    {% else %}
                                        <span class="{{ text_class }}">{{ time_val }}</span>
                                    {% endif %}
                                {% endif %}
                            {% endmacro %}

                            {% for job in jobs %}
                                {% set is_same = False %}
                                {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.PO_Date == job.PO_Date %}
                                    {% set is_same = True %}
                                {% endif %}
                                
                                {% set start_load_color = '' %}
                                {% if job.T2_StartLoad %}
                                    {% if job.is_start_late %} 
                                        {% set start_load_color = 'text-red-600 font-bold' %}
                                    {% else %} 
                                        {% set start_load_color = 'text-green-600 font-bold' %} 
                                    {% endif %}
                                {% endif %}
                                
                                <tr class="border-b hover:bg-gray-50 transition">
                                    <td class="p-2 border-r font-bold bg-gray-50 sticky left-0 z-10 border-gray-200 text-indigo-900">
                                        {% if not is_same %} ‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ job.Car_No }} {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}{{ job.PO_Date | thai_date }}{% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200 font-bold">
                                        {% if not is_same %}{{ job.Round }}{% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200 text-left pl-4 font-bold text-indigo-700">{{ job.Branch_Name }}</td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %} {{ job.Plate }} {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200 font-medium">
                                        {% if not is_same %} {{ job.Driver }} {% endif %}
                                    </td>
                                    
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T1_Enter, job.L1_Loc) }}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T2_StartLoad, job.L2_Loc, start_load_color) }}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T3_EndLoad, job.L3_Loc) }}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T4_SubmitDoc, job.L4_Loc) }}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T5_RecvDoc, job.L5_Loc) }}
                                        {% endif %}
                                    </td>
                                    <td class="p-2 border-r border-gray-200">
                                        {% if not is_same %}
                                            {{ report_time_cell(job.T6_Exit, job.L6_Loc) }}
                                        {% endif %}
                                    </td>
                                    
                                    <td class="p-2 border-r font-bold text-green-700 bg-green-50/50 border-gray-200">
                                        {{ report_time_cell(job.T7_ArriveBranch, job.L7_Loc, 'text-green-800') }}
                                    </td>
                                    <td class="p-2 font-bold text-red-600 bg-red-50/50">
                                        {{ report_time_cell(job.T8_EndJob, job.L8_Loc, 'text-red-700') }}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="mt-2 text-right text-[10px] text-gray-400">Data refreshed at: <span id="report-time"></span></div>
        </div>
    </div>
</div>

<script>
    // Tab Logic
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow');
            btn.classList.add('bg-white', 'text-gray-600');
        });
        document.getElementById(tabId).classList.remove('hidden');
        let btn = document.getElementById(tabId.replace('tab-', 'btn-'));
        btn.classList.remove('bg-white', 'text-gray-600');
        btn.classList.add('bg-indigo-600', 'text-white', 'shadow');
        localStorage.setItem('activeTab', tabId);
    }

    // Helper Functions
    function updatePlate() {
        const select = document.getElementById('driver_select');
        const selectedOption = select.options[select.selectedIndex];
        const plate = selectedOption.getAttribute('data-plate');
        document.getElementById('plate_input').value = plate || "";
    }

    function addBranchField() {
        const container = document.getElementById('branch-container');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `<span class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center shadow-sm">${count}</span><input type="text" name="branches" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà ${count}" required class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5 border"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2 transition"><i class="fa-solid fa-trash"></i></button>`;
        container.appendChild(div);
    }

    function copyCustomerLink() {
        let url = window.location.origin + "/tracking";
        navigator.clipboard.writeText(url).then(() => alert("‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß:\n" + url));
    }

    function triggerExport() {
        const selectedDate = document.getElementById('report_date_filter').value;
        let url = '/export_excel';
        if (selectedDate) url += `?date_filter=${selectedDate}`;
        
        // ‡πÉ‡∏ä‡πâ window.location.href ‡πÅ‡∏ó‡∏ô window.open ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        window.location.href = url;
    }

    function triggerCustomerPDF() {
        const selectedDate = document.getElementById('report_date_filter').value;
        let url = '/export_pdf';
        if (selectedDate) {
            url += `?date_filter=${selectedDate}`;
        }
        
        // ‡πÉ‡∏ä‡πâ window.location.href ‡πÅ‡∏ó‡∏ô window.open ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        window.location.href = url;
    }
	
	function triggerCompactPDF() {
    const selectedDate = document.getElementById('report_date_filter').value;
    let url = '/export_pdf_summary'; 
    if (selectedDate) {
        url += `?date_filter=${selectedDate}`;
    }
    window.location.href = url;
	}
	
	// --- [UPDATED] LINE Share Function (Exact Match to Image) ---
    function shareLine(shiftType) {
        // 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const dayData = {{ line_data_day | tojson }};
        const nightData = {{ line_data_night | tojson }};
        
        const dataList = (shiftType === 'day') ? dayData : nightData;
        const shiftName = (shiftType === 'day') ? '‡∏£‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô' : '‡∏£‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô';
        const shiftEmoji = (shiftType === 'day') ? '‚òÄÔ∏è' : 'üåô';
        
        // 2. Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà PO
        const poDateVal = document.getElementById('customer_date_filter').value;
        const [py, pm, pd] = poDateVal.split('-');
        const yearThaiShort = (parseInt(py) + 543).toString().slice(2);
        const poDateThai = `${pd}.${pm}.${yearThaiShort}`; 
        
        if (dataList.length === 0) {
            alert(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${shiftName}`);
            return;
        }

        const loadDateShow = dataList[0].load_date; 

        // --- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Header ---
        let msg = `üìÑ LMT PO ${poDateThai} (${shiftEmoji} ${shiftName} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${loadDateShow})\n\n`;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
        let groupedByRound = {};
        dataList.forEach(item => {
            let r = item.round || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤";
            if (!groupedByRound[r]) groupedByRound[r] = [];
            groupedByRound[r].push(item);
        });

        // Loop ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
        for (const [roundTime, cars] of Object.entries(groupedByRound)) {
            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏ß‡∏•‡∏≤
            msg += `üïí ‡∏£‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î ${roundTime} ‡∏ô.\n`;
            
            cars.forEach(car => {
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ (Truck Icon, No Person Icon)
                msg += `üöõ ‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà ${car.car_no} ${car.plate} ${car.driver}\n`;
                
                // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î üìç ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)
                car.branches.forEach(branch => {
                    msg += `üìç ${branch}\n`;
                });
                
                msg += `\n`; // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏ö‡∏Ñ‡∏±‡∏ô (‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°)
            });
        }

        // Encode ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á
        const encodedMsg = encodeURIComponent(msg);
        const lineUrl = `https://line.me/R/msg/text/?${encodedMsg}`;
        window.open(lineUrl, '_blank');
    }
	
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        const savedTab = localStorage.getItem('activeTab') || 'tab-monitor';
        if(tabParam) switchTab('tab-' + tabParam); else switchTab(savedTab);
        document.getElementById('report-time').innerText = new Date().toLocaleString('th-TH');
    });
</script>

{% endblock %}