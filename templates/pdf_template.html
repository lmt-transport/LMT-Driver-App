<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<style>
    /* ประกาศฟอนต์สำหรับ xhtml2pdf */
    @font-face {
        font-family: 'Kanit';
        src: url('/static/Kanit-Regular.ttf'); /* ต้องตรงกับไฟล์ใน static */
    }
    @font-face {
        font-family: 'Kanit';
        src: url('/static/Kanit-Bold.ttf');
        font-weight: bold;
    }

    @page {
        size: A4 landscape; /* แนวนอน */
        margin: 1cm;
        @top-right {
            content: "หน้า " counter(page);
            font-family: 'Kanit';
            font-size: 9px;
        }
    }

    body {
        font-family: 'Kanit', sans-serif;
        font-size: 10px;
        color: #000;
    }

    /* Header */
    .header-table { width: 100%; margin-bottom: 10px; border: none; }
    .header-table td { border: none; vertical-align: bottom; }
    .logo { width: 40px; height: auto; }
    .title { font-size: 18px; font-weight: bold; color: #2c3e50; }
    .subtitle { font-size: 10px; color: #555; }
    .po-box { 
        font-size: 16px; font-weight: bold; 
        border: 1px solid #000; padding: 5px; 
        background-color: #f0f0f0; text-align: center;
    }

    /* Data Table */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #000;
    }
    .data-table th {
        background-color: #e0e0e0;
        color: #000;
        font-weight: bold;
        padding: 4px;
        border: 1px solid #000;
        text-align: center;
        font-size: 10px;
    }
    .data-table td {
        padding: 3px;
        border: 1px solid #666;
        vertical-align: middle;
        text-align: center;
        font-size: 10px;
    }
    
    /* Grouping */
    .new-group { border-top: 2px solid #000 !important; }
    .sub-row td { border-top: 1px dotted #ccc; }
    
    /* Column Specifics */
    .text-left { text-align: left; padding-left: 5px; }
    .bg-grey { background-color: #f9f9f9; }
    .font-bold { font-weight: bold; }

</style>
</head>
<body>

    <table class="header-table">
        <tr>
            <td width="60">
                <img src="/static/mylogo.png" class="logo">
            </td>
            <td align="left">
                <div class="title">LMT Transport System</div>
                <div class="subtitle">รายงานสรุปการขนส่งประจำวัน</div>
            </td>
            <td align="right" width="150">
                <div class="po-box">PO. {{ po_date }}</div>
                <div style="font-size: 8px; margin-top: 2px;">Export: {{ print_date }}</div>
            </td>
        </tr>
    </table>

    <table class="data-table">
        <thead>
            <tr>
                <th width="5%">คันที่</th>
                <th width="10%">ทะเบียน</th>
                <th width="15%">คนขับ</th>
                <th width="6%">เวลา</th>
                <th width="20%">สาขาปลายทาง</th>
                <th width="6%">เข้าฯ</th>
                <th width="6%">เริ่ม</th>
                <th width="6%">เสร็จ</th>
                <th width="6%">เอกสาร</th>
                <th width="6%">รับฯ</th>
                <th width="6%">ออกฯ</th>
                <th width="7%">ถึงสาขา</th>
                <th width="7%">จบงาน</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
                {% set is_same = False %}
                {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.Round == job.Round %}
                    {% set is_same = True %}
                {% endif %}

                <tr class="{% if not is_same %}new-group{% endif %}">
                    <td class="bg-grey font-bold">{% if not is_same %}{{ job.Car_No }}{% endif %}</td>
                    <td>{% if not is_same %}{{ job.Plate }}{% endif %}</td>
                    <td class="text-left">{% if not is_same %}{{ job.Driver }}{% endif %}</td>
                    <td class="font-bold">{% if not is_same %}{{ job.Round }}{% endif %}</td>
                    
                    <td class="text-left">{{ job.Branch_Name }}</td>
                    
                    {% if not is_same %}
                        <td>{{ job.T1_Enter }}</td>
                        <td>{{ job.T2_StartLoad }}</td>
                        <td>{{ job.T3_EndLoad }}</td>
                        <td>{{ job.T4_SubmitDoc }}</td>
                        <td>{{ job.T5_RecvDoc }}</td>
                        <td>{{ job.T6_Exit }}</td>
                    {% else %}
                        <td colspan="6" style="background-color: #fcfcfc;"></td>
                    {% endif %}
                    
                    <td>{{ job.T7_ArriveBranch }}</td>
                    
                    <td class="font-bold">
                        {% if not is_same %}
                            {# หาเวลาจบงานของ Trip นี้จาก Dict ที่ส่งมา #}
                            {% set trip_key = (job.PO_Date|string, job.Car_No|string, job.Round|string) %}
                            {{ trip_last_end_time.get(trip_key, '-') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>