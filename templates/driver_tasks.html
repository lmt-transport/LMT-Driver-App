{% extends "layout.html" %}
{% block content %}

<div class="sticky top-0 z-30 bg-white/95 backdrop-blur-sm border-b border-gray-100 shadow-sm">
    <div class="max-w-2xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-100 p-2 rounded-full text-indigo-600">
                <i class="fa-solid fa-user-astronaut text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg font-bold text-gray-800 leading-tight">งานของคุณ</h2>
                <p class="text-xs text-gray-500 font-medium">{{ name }}</p>
            </div>
        </div>
        <a href="/driver" class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition flex items-center gap-1">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> เปลี่ยนชื่อ
        </a>
    </div>
</div>

<div class="max-w-2xl mx-auto px-4 pb-20 pt-4">

{% if jobs|length == 0 %}
    <div class="flex flex-col items-center justify-center py-16 text-center">
        <div class="bg-green-50 p-6 rounded-full mb-4 animate-bounce">
            <i class="fa-solid fa-mug-hot text-5xl text-green-500"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800">ไม่มีงานค้าง</h3>
        <p class="text-gray-400 mt-1 text-sm">พักผ่อนได้เต็มที่เลยครับ!</p>
    </div>
{% else %}

    {% set current_job = jobs[0] %}
    {% set active_trip_key = current_job.PO_Date ~ '-' ~ current_job.Round ~ '-' ~ current_job.Car_No %}
    
    {% set waiting_trip_keys = [] %}
    {% for j in jobs %}
        {% set k = j.PO_Date ~ '|' ~ j.Round ~ '|' ~ j.Car_No %}
        {% if (j.PO_Date ~ '-' ~ j.Round ~ '-' ~ j.Car_No) != active_trip_key and k not in waiting_trip_keys %}
             {% set _ = waiting_trip_keys.append(k) %}
        {% endif %}
    {% endfor %}
    
    {% if waiting_trip_keys|length > 0 %}
        <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 mb-6 flex items-center justify-between shadow-sm animate-pulse">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 text-blue-600 w-8 h-8 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <div class="text-xs text-blue-500 font-bold uppercase">คิวงานถัดไป</div>
                    <div class="text-sm font-bold text-blue-800">มีงานรออีก {{ waiting_trip_keys|length }} เที่ยว</div>
                </div>
            </div>
            <span class="text-[10px] text-blue-400 font-medium bg-white px-2 py-1 rounded border border-blue-100">ทำให้เสร็จทีละงานนะ!</span>
        </div>
    {% endif %}

    <div class="flex flex-col gap-2 mb-4">
        <div class="flex items-center gap-3">
            <div class="flex-1 h-px bg-gray-200"></div>
            <div class="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full border border-gray-200 shadow-sm">
                <i class="fa-regular fa-calendar-days text-gray-400"></i>
                
                <span class="text-sm font-bold text-gray-800">
                    PO: {% if current_job.PO_Date | thai_date %}{{ current_job.PO_Date | thai_date }}{% else %}{{ current_job.PO_Date }}{% endif %}
                </span>
                
                {% if current_job.PO_Date == today_date %}
                    <span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full ml-1">งานวันนี้</span>
                {% elif current_job.PO_Date < today_date %}
                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full ml-1">งานตกค้าง</span>
                {% else %}
                    <span class="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded-full ml-1 flex items-center gap-1">
                        <i class="fa-solid fa-bolt"></i> โหลดสินค้าวันนี้
                    </span>
                {% endif %}
            </div>
            <div class="flex-1 h-px bg-gray-200"></div>
        </div>

        {% if current_job.PO_Date > today_date %}
        <div class="text-center animate-pulse">
            <span class="text-[11px] text-orange-600 bg-orange-50 px-3 py-1 rounded-lg border border-orange-100 inline-block">
                <i class="fa-solid fa-circle-info"></i> เป็น PO ล่วงหน้า แต่ต้องเริ่มงานวันนี้ตามเวลาโหลดครับ
            </span>
        </div>
        {% endif %}
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden mb-8 relative ring-2 ring-indigo-50">
        
        <div class="bg-gradient-to-r from-slate-800 to-slate-700 px-4 py-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-400 text-slate-900 w-10 h-10 rounded-xl flex items-center justify-center font-extrabold text-xl shadow-lg border-2 border-slate-600 transform rotate-3">
                    {{ current_job.Car_No }}
                </div>
                <div>
                    <div class="text-[10px] text-slate-300 font-medium uppercase tracking-wide opacity-80">ทะเบียนรถ</div>
                    <div class="text-base font-bold font-mono tracking-wider">{{ current_job.Plate }}</div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-slate-300 font-medium uppercase opacity-80">เวลาโหลด</div>
                <div class="text-xl font-bold text-yellow-400 font-mono leading-none">{{ current_job.Round }}</div>
            </div>
        </div>

        {% set factory_row_id = current_job.row_id %}
        
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center gap-2 mb-3 text-sm font-bold text-gray-700">
                <span class="bg-blue-100 text-blue-600 w-6 h-6 flex items-center justify-center rounded-full text-xs"><i class="fa-solid fa-industry"></i></span>
                ขั้นตอนโรงงาน
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                {% set factory_buttons = [
                    ('1', 'เข้าโรงงาน', 'from-blue-500 to-blue-600', 'fa-door-open', current_job.T1_Enter),
                    ('2', 'เริ่มโหลด', 'from-indigo-500 to-indigo-600', 'fa-dolly', current_job.T2_StartLoad),
                    ('3', 'โหลดเสร็จ', 'from-cyan-500 to-cyan-600', 'fa-clipboard-check', current_job.T3_EndLoad),
                    ('4', 'ยื่นเอกสาร', 'from-amber-500 to-amber-600', 'fa-file-export', current_job.T4_SubmitDoc),
                    ('5', 'รับเอกสาร', 'from-orange-500 to-orange-600', 'fa-file-invoice', current_job.T5_RecvDoc),
                    ('6', 'ออกโรงงาน', 'from-purple-500 to-purple-600', 'fa-truck-fast', current_job.T6_Exit)
                ] %}

                {% for step_id, label, grad, icon, val in factory_buttons %}
                <form action="/update_status" method="POST" class="w-full" id="form-{{ factory_row_id }}-{{ step_id }}">
                    <input type="hidden" name="row_id" value="{{ factory_row_id }}">
                    <input type="hidden" name="driver_name" value="{{ name }}">
                    <input type="hidden" name="step" value="{{ step_id }}">
                    <input type="hidden" name="lat" id="lat-{{ factory_row_id }}-{{ step_id }}">
                    <input type="hidden" name="long" id="long-{{ factory_row_id }}-{{ step_id }}">
                    
                    <button type="button" onclick="getLocationAndSubmit('{{ factory_row_id }}', '{{ step_id }}')"
                        class="w-full aspect-[4/3] rounded-xl shadow-sm active:scale-95 transition-all flex flex-col items-center justify-center gap-1 relative overflow-hidden group
                        {% if val %} 
                            bg-gray-50 border border-gray-100 text-gray-400 cursor-default
                        {% else %} 
                            bg-gradient-to-br {{ grad }} text-white hover:shadow-lg
                        {% endif %}"
                        {% if val %} disabled {% endif %}>
                        
                        {% if val %}
                            <div class="absolute top-1 right-1 text-green-500"><i class="fa-solid fa-circle-check text-xs"></i></div>
                            <div class="text-xs font-bold text-gray-600 mt-1 font-mono">{{ val }}</div>
                            <div class="text-[9px] text-gray-400">{{ label }}</div>
                        {% else %}
                            <i class="fa-solid {{ icon }} text-xl mb-0.5 group-hover:scale-110 transition-transform"></i>
                            <span class="text-[9px] font-medium leading-tight text-center px-1">{{ label }}</span>
                        {% endif %}
                    </button>
                </form>
                {% endfor %}
            </div>
        </div>

        <div class="p-4 bg-gray-50/50">
            <div class="flex items-center gap-2 mb-3 text-sm font-bold text-gray-700">
                <span class="bg-green-100 text-green-600 w-6 h-6 flex items-center justify-center rounded-full text-xs"><i class="fa-solid fa-map-location-dot"></i></span>
                จุดส่งสินค้า
            </div>

            <div class="space-y-3">
                {% set active_rows = [] %}
                {% for job in jobs %}
                    {% if job.PO_Date == current_job.PO_Date and job.Round == current_job.Round and job.Car_No == current_job.Car_No %}
                        {% set _ = active_rows.append(job) %}
                    {% endif %}
                {% endfor %}

                {% for branch_job in active_rows %}
                    <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm relative">
                        <div class="absolute -left-1 top-1/2 transform -translate-y-1/2">
                            <div class="bg-slate-800 text-white w-6 h-6 rounded-r-md flex items-center justify-center text-[10px] font-bold shadow-sm">
                                {{ loop.index }}
                            </div>
                        </div>

                        <div class="ml-4">
                            <div class="flex justify-between items-start mb-3 pl-2">
                                <span class="text-sm font-bold text-gray-800 leading-snug">{{ branch_job.Branch_Name }}</span>
                                {% if branch_job.Status == 'Done' %}
                                    <span class="bg-green-100 text-green-600 text-[10px] px-2 py-0.5 rounded-full font-bold"><i class="fa-solid fa-check"></i> เสร็จ</span>
                                {% endif %}
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                {% set branch_buttons = [
                                    ('7', 'ถึงสาขา', 'bg-emerald-500', 'fa-location-dot', branch_job.T7_ArriveBranch),
                                    ('8', 'จบงาน', 'bg-rose-600', 'fa-flag-checkered', branch_job.T8_EndJob)
                                ] %}

                                {% for step_id, label, color, icon, val in branch_buttons %}
                                <form action="/update_status" method="POST" class="w-full" id="form-{{ branch_job.row_id }}-{{ step_id }}">
                                    <input type="hidden" name="row_id" value="{{ branch_job.row_id }}">
                                    <input type="hidden" name="driver_name" value="{{ name }}">
                                    <input type="hidden" name="step" value="{{ step_id }}">
                                    <input type="hidden" name="lat" id="lat-{{ branch_job.row_id }}-{{ step_id }}">
                                    <input type="hidden" name="long" id="long-{{ branch_job.row_id }}-{{ step_id }}">
                                    
                                    <button type="button" onclick="getLocationAndSubmit('{{ branch_job.row_id }}', '{{ step_id }}')"
                                        class="w-full py-3 rounded-lg shadow-sm active:scale-95 transition flex items-center justify-center gap-2
                                        {% if val %} 
                                            bg-gray-50 border border-gray-200 text-gray-800 font-mono font-bold text-sm cursor-default
                                        {% else %} 
                                            {{ color }} text-white font-medium text-xs hover:opacity-90
                                        {% endif %}"
                                        {% if val %} disabled {% endif %}>
                                        
                                        {% if val %}
                                            {{ val }}
                                        {% else %}
                                            <i class="fa-solid {{ icon }}"></i> {{ label }}
                                        {% endif %}
                                    </button>
                                </form>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    </div>

{% endif %}

</div>

<script>
    function getLocationAndSubmit(rowId, stepId) {
        const btn = document.querySelector(`#form-${rowId}-${stepId} button`);
        const originalContent = btn.innerHTML;
        
        btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin text-lg"></i>`;
        btn.disabled = true;
        btn.classList.add('opacity-70');

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById(`lat-${rowId}-${stepId}`).value = position.coords.latitude;
                    document.getElementById(`long-${rowId}-${stepId}`).value = position.coords.longitude;
                    document.getElementById(`form-${rowId}-${stepId}`).submit();
                },
                function(error) {
                    alert("⚠️ กรุณาเปิด GPS เพื่อบันทึกเวลา");
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    btn.classList.remove('opacity-70');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            alert("❌ อุปกรณ์ไม่รองรับ GPS");
            document.getElementById(`form-${rowId}-${stepId}`).submit();
        }
    }
</script>
{% endblock %}