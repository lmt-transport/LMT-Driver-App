<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report PO.{{ po_date }}</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- 1. Font Setup --- */
        @font-face {
            font-family: 'KanitLocal';
            src: url("{{ url_for('static', filename='Kanit-Regular.ttf') }}") format('truetype');
            font-weight: normal;
        }
        @font-face {
            font-family: 'KanitLocal';
            src: url("{{ url_for('static', filename='Kanit-Bold.ttf') }}") format('truetype');
            font-weight: bold;
        }

        body {
            font-family: 'KanitLocal', sans-serif;
            font-size: 12px;
            background: #f3f4f6; /* พื้นหลังสีเทาให้ดูง่าย */
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Table Styles (ใช้ร่วมกันทั้งหน้าจอและ PDF) --- */
        .report-container {
            background: white;
            width: 100%;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* เงาสำหรับดูหน้าจอ */
        }

        .report-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px;
        }
        .company-info { display: flex; align-items: center; gap: 15px; }
        .logo { height: 50px; width: auto; }
        .company-name { font-size: 22px; font-weight: bold; line-height: 1.1; }
        
        .po-badge {
            font-size: 24px; font-weight: bold; color: #000;
            border: 2px solid #000; padding: 5px 15px; border-radius: 8px;
            background-color: #f9fafb; display: inline-block;
        }

        table {
            width: 100%; border-collapse: collapse; margin-bottom: 10px;
            table-layout: fixed; /* บังคับความกว้างคอลัมน์ */
        }
        
        th, td {
            border: 1px solid #444; padding: 6px 4px;
            text-align: center; vertical-align: middle;
            word-wrap: break-word; overflow: hidden;
            font-size: 12px; /* ฟอนต์มาตรฐาน */
        }
        th { background-color: #e5e7eb !important; font-weight: bold; color: #000; }
        
        /* Column Widths */
        .col-car { width: 6%; background-color: #fafafa; font-weight: bold; }
        .col-plate { width: 9%; }
        .col-driver { width: 12%; text-align: left !important; padding-left: 5px; }
        .col-load { width: 7%; font-weight: bold; }
        .col-branch { width: 18%; text-align: left !important; padding-left: 5px; }
        .col-time { width: 6%; }
        .col-status { width: 8%; font-weight: bold; }

        .group-start { border-top: 2px solid #000; }
        .bg-gray { background-color: #fcfcfc; }

        /* --- Action Bar --- */
        .action-bar {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.95); padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; gap: 10px;
            z-index: 9999; backdrop-filter: blur(5px);
        }
        .spacer { height: 60px; }
        .btn {
            padding: 10px 20px; border-radius: 8px; font-weight: bold;
            cursor: pointer; border: none; display: flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: white;
        }
        .btn-download { background-color: #ef4444; }
        .btn-close { background-color: #6b7280; }

        /* --- CSS สำหรับตัวโคลนที่จะเอาไปทำ PDF --- */
        .pdf-clone-container {
            position: absolute;
            left: -9999px; /* ซ่อนไว้นอกจอ */
            top: 0;
            /* กำหนดความกว้างให้ใหญ่และชัดเจน */
            width: 1400px !important; 
            background: white;
            padding: 20px;
        }
        /* ปรับแต่งเฉพาะตอนเป็น PDF ให้ดูดียิ่งขึ้น */
        .pdf-clone-container table { font-size: 14px; } 
        .pdf-clone-container th { font-size: 14px; background-color: #ddd !important; }
        .pdf-clone-container .report-container { box-shadow: none; }
    </style>
</head>
<body>

    <div class="action-bar">
        <button onclick="generatePDF()" class="btn btn-download">
            <i class="fa-solid fa-file-pdf"></i> บันทึก PDF
        </button>
        <button onclick="window.close()" class="btn btn-close">
            <i class="fa-solid fa-xmark"></i> ปิด
        </button>
    </div>
    <div class="spacer"></div>

    <div id="report-content" class="report-container">
        
        <div class="report-header">
            <div class="company-info">
                <img src="{{ url_for('static', filename='mylogo.png') }}" alt="Logo" class="logo" crossorigin="anonymous">
                <div>
                    <div class="company-name">LMT Transport System</div>
                    <div style="color:#666;">รายงานสรุปการขนส่งประจำวัน</div>
                </div>
            </div>
            <div class="po-info">
                <div class="po-badge">PO. {{ po_date }}</div>
                <div style="font-size:10px; margin-top:5px;">Export: {{ print_date }}</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="col-car">คันที่</th>
                    <th class="col-plate">ทะเบียน</th>
                    <th class="col-driver">คนขับ</th>
                    <th class="col-load">เวลาโหลด</th>
                    <th class="col-branch">สาขาปลายทาง</th>
                    <th class="col-time">เข้าโรงงาน</th>
                    <th class="col-time">เริ่มโหลด</th>
                    <th class="col-time">โหลดเสร็จ</th>
                    <th class="col-time">ยื่นเอกสาร</th>
                    <th class="col-time">รับเอกสาร</th>
                    <th class="col-time">ออกโรงงาน</th>
                    <th class="col-status">ถึงสาขา</th>
                    <th class="col-status">จบงาน</th>
                </tr>
            </thead>
            <tbody>
                {% if jobs|length == 0 %}
                    <tr><td colspan="13" style="padding: 30px; color: #888;">-- ไม่พบข้อมูลในวันนี้ --</td></tr>
                {% else %}
                    {% for job in jobs %}
                        {% set is_same = False %}
                        {% if not loop.first and loop.previtem.Car_No == job.Car_No and loop.previtem.Driver == job.Driver and loop.previtem.Round == job.Round %}
                            {% set is_same = True %}
                        {% endif %}

                        <tr class="{{ 'group-start' if not is_same else '' }}">
                            <td class="col-car">{% if not is_same %} {{ job.Car_No }} {% endif %}</td>
                            <td>{% if not is_same %} {{ job.Plate }} {% endif %}</td>
                            <td class="col-driver">{% if not is_same %} {{ job.Driver }} {% endif %}</td>
                            <td style="font-weight:bold;">{% if not is_same %} {{ job.Round }} {% endif %}</td>
                            
                            <td class="col-branch">{{ job.Branch_Name }}</td>
                            
                            {% if not is_same %}
                                <td>{{ job.T1_Enter }}</td>
                                <td>{{ job.T2_StartLoad }}</td>
                                <td>{{ job.T3_EndLoad }}</td>
                                <td>{{ job.T4_SubmitDoc }}</td>
                                <td>{{ job.T5_RecvDoc }}</td>
                                <td>{{ job.T6_Exit }}</td>
                            {% else %}
                                <td colspan="6" class="bg-gray" style="border-right: 1px solid #444;"></td>
                            {% endif %}
                            
                            <td>{{ job.T7_ArriveBranch }}</td>
                            <td style="font-weight:bold;">{{ job.T8_EndJob }}</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>

        <div style="text-align:center; margin-top:20px; font-size:10px; color:#aaa;">
            เอกสารนี้สร้างโดยระบบ LMT Driver App
        </div>
    </div>

    <script>
        function generatePDF() {
            const btn = document.querySelector('.btn-download');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังประมวลผล...';
            btn.disabled = true;

            // 1. รอให้ฟอนต์โหลดเสร็จ (สำคัญที่สุด)
            document.fonts.ready.then(function () {
                
                // 2. สร้าง "ร่างโคลน" ของตาราง
                const originalElement = document.getElementById('report-content');
                const clone = originalElement.cloneNode(true);
                
                // 3. ปรับแต่งร่างโคลน (เพิ่มความกว้างเพื่อให้คมชัด ไม่ตกขอบ)
                clone.classList.add('pdf-clone-container'); 
                document.body.appendChild(clone); // ใส่เข้าไปใน body แต่ CSS สั่งซ่อนไว้ off-screen

                // 4. ตั้งค่า html2pdf
                const opt = {
                    margin:       [5, 5, 5, 5], // ขอบบนล่างซ้ายขวา (mm)
                    filename:     'Report_PO_{{ po_date|replace("/", "-") }}.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, // คูณ 2 เพื่อความชัดบน Retina
                        useCORS: true, // ดึงรูป Logo
                        letterRendering: true, // ช่วยเรื่องฟอนต์
                        scrollY: 0
                    },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' },
                    pagebreak:    { mode: ['avoid-all', 'css'] }
                };

                // 5. สั่งพิมพ์จาก "ร่างโคลน" (Clone)
                html2pdf().set(opt).from(clone).save().then(function(){
                    // เสร็จแล้วลบร่างโคลนทิ้ง
                    document.body.removeChild(clone);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            });
        }
    </script>

</body>
</html>